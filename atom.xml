<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>복면 개발왕</title>
  
  <subtitle>For Memory</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://the-masked-developer.github.io/"/>
  <updated>2022-09-13T06:26:04.097Z</updated>
  <id>https://the-masked-developer.github.io/</id>
  
  <author>
    <name>maskking</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Face Detection</title>
    <link href="https://the-masked-developer.github.io/wiki/face-detection/"/>
    <id>https://the-masked-developer.github.io/wiki/face-detection/</id>
    <published>2022-03-14T12:23:22.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<p>Face detection이란, 이미지 또는 동영상에서 사람의 얼굴 부분을 찾아서 bounding box를 그려주는 작업을 말한다. 본 문서에서는 이러한 face detection이 어떻게 이루어지는지, face detection을 위해 사용되는 feature가 어떤 것이 있는지를 논의한다.</p><h1 id="Overview-of-Face-Detection"><a href="#Overview-of-Face-Detection" class="headerlink" title="Overview of Face Detection"></a>Overview of Face Detection</h1><p>Face detection은 이미지 또는 동영상으로부터 사람의 얼굴 부분을 찾아서 bounding box를 찾아주는 알고리즘들을 가리킨다. 이미지나 동영상을 촬영할 때, 보통 가장 중요하게 생각되는 객체는 사람으로, 특히, 사람의 얼굴이 이미지나 동영상의 중심이 되는 경우가 많다. 따라서, 이미지나 동영상을 촬영하거나, 이미지를 처리할 때, 사람의 얼굴 부분을 탐지하고 사람의 얼굴을 중심으로 이미지나 동영상을 처리하는 어플리케이션이 많다.</p><p>Face detection은 보통 다음과 같은 과정으로 이루어진다.</p><ol><li>이미지(또는 비디오 프레임) 한 장을 입력으로 받는다.</li><li>슬라이딩 윈도우 기법으로 이미지 각 부분에 대해 feature를 추출한다.</li><li>계산된 feature를 바탕으로 이미지의 각 부분이 사람의 얼굴인지, 얼굴이 아닌지 판별한다.</li><li>사람의 얼굴이라고 판별된 부분의 bounding box를 리턴한다.</li></ol><p>이때, 가장 중요한 부분이라고 할 수 있는 부분은 바로, 이미지의 각 부분에 대해 feature를 추출하는 것이라고 할 수 있다. 이때, feature는 사람의 얼굴 영역에서 나온 값과 사람의 얼굴이 아닌 영역에서 나온 값이 구분되는 feature여야 한다.</p><p>본 문서에서는 얼굴 탐지를 위해 가장 많이 사용되는 feature인 Haar feature를 살펴보고, Haar feature를 계산하기 위한 방법을 살펴본다.</p><p>여러 얼굴 이미지에 대해 Haar feature를 계산하고, 얼굴이 아닌 이미지에 대해 Haar feature가 계산되었다면, SVM과 같은 classifier를 학습할 수 있다. 학습된 SVM은 어떤 얼굴 이미지가 들어왔을 때, 얼굴이라고 판단할 수 있을 것이고, 얼굴이 아닌 이미지가 들어왔을 때에는 얼굴이 아니라고 판단할 수 있을 것이다.</p><h1 id="Haar-Features-for-Face-Detection"><a href="#Haar-Features-for-Face-Detection" class="headerlink" title="Haar Features for Face Detection"></a>Haar Features for Face Detection</h1><p>이미지에서 feature라고 하면, edge, boundary 또는 SIFT와 같은 feature가 가장 먼저 떠오르게 된다. 사람의 얼굴 부분은 edge 및 boundary가 복잡하지만, edge와 boundary가 복잡한 객체는 얼마든지 많으므로, 얼굴을 탐지하는 feature로 사용하기에는 부적합하다. SIFT의 경우, 두 영역간 similarity를 비교하는데 주로 뛰어난 성능을 보여줄 뿐, 어떤 영역을 특정 카테고리로 판별하는 데에는 적합하지 않다.</p><p>따라서, 이미지의 어떤 영역이 얼굴인지를 판별하기 위해서는 조금 다른 feature가 필요한데, 보통 얼굴을 탐지하는 데 있어서 가장 널리 사용되는 feature는 Haar feature이다.</p><p>Haar feature는 여러 스케일, 여러 가지의 Haar filter로 이미지의 각 영역에 적용한 후, 이들 필터들로 계산된 response의 합으로 계산된다.</p><img src="https://user-images.githubusercontent.com/26874750/158171269-55a921a1-f592-40bc-8335-48864bd0c581.png" alt="Untitled" style="zoom:80%;" /><p>‘$*$’ 표시는 convolution을 의미하며, filter에서 흰 부분은 +1 값, 검은 부분은 -1 값을 의미한다.</p><p>하나의 Haar feature는 하나의 Haar filter를 이미지에 convolution하여 얻어진다. Haar filter는 large-scale image derivative라고 볼 수 있는데, 다음의 Haar filter를 예로 들어보자.</p><p><img src="https://user-images.githubusercontent.com/26874750/158171329-5d75ee2c-c178-408c-aa32-9156a85a7c10.png" alt="Untitled 1"></p><p>이 Haar filter는 이미지에서 $x$축 방향의 edge에 민감하게 반응하는 edge detection filter(e.g. Sobel filter)와 유사한 모양이다. 즉, 이 Haar filter는 꽤 큰 크기의 $x$방향 edge detection filter라고 볼 수 있다.</p><p>마찬가지로, 다음의 Haar filter는 $y$축 방향으로의 큰 edge detection filter라고 볼 수 있다.</p><p><img src="https://user-images.githubusercontent.com/26874750/158171361-27b5a8d5-bd47-465e-9a6d-4658467571e3.png" alt="Untitled 2"></p><p>다음의 Haar filter의 경우, 2차 미분을 이용한 edge detector인 Laplacian filter와 유사한 역할이라고 볼 수 있다.</p><p><img src="https://user-images.githubusercontent.com/26874750/158171395-2bbcc884-d807-4821-9ee8-5ac638eb04a3.png" alt="Untitled 3"></p><p>Haar feature는 이처럼, 큰 스케일의 edge detection filter를 여러개 이용하여 추출한 feature를 의미한다. 이때, 다양한 스케일의 얼굴을 탐지하기 위해 위와 같은 Haar filter를 여러 스케일로 설계하게 된다.</p><h2 id="Computation-Cost-for-Haar-Features"><a href="#Computation-Cost-for-Haar-Features" class="headerlink" title="Computation Cost for Haar Features"></a>Computation Cost for Haar Features</h2><p>Face detection은 카메라에 실시간으로 적용되는 경우가 많기에, 연산 비용이 적어야 한다. Haar feature를 계산하는 것은 convolution 곱을 직접 계산할 필요없이, (흰 영역의 픽셀 값들의 합) - (검은 영역의 픽셀 값들의 합)으로 간단하게 계산이 가능하기에 매우 효율적이다.</p><p>그럼에도 불구하고, Haar feature를 계산할 때, 모든 픽셀에 대해 계산해야 하며, Haar filter 역시 한두개가 아니다. 또한, Haar filter의 스케일도 다양하게 해야 하므로 그 연산 비용이 커지게 된다. Haar filter 하나에 대한 Haar feature 계산은 매우 효율적이지만, 전체적으로 보았을 때, 좀 더 속도를 개선할 필요가 있다. 이때, 사용될 수 있는 것이 integral image 방법이다.</p><h3 id="Integral-Image"><a href="#Integral-Image" class="headerlink" title="Integral Image"></a>Integral Image</h3><p>Integral image란, 모든 픽셀좌표 $(i, j)$에 대해 다음과 같이 정의된다.</p><p>$$<br>II(i, j) = \sum_{m=1}^i \sum_{n=1}^j I(m, n)<br>$$</p><p>이때, $I(m, n)$은 $(m, n)$ 좌표에서의 이미지 픽셀값이고, $II(i, j)$는 $(i, j)$ 좌표에서의 integral image 값이다.</p><p>그림으로 표현하면 다음과 같다.</p><p><img src="https://user-images.githubusercontent.com/26874750/158171444-340902b4-94f9-402d-9c11-38fbb54265e5.png" alt="Untitled 4"></p><p>Integral image에서 $(i, j)$ 좌표에 들어갈 값은 원본 이미지에서 $(1, 1)$ 좌표를 좌상단 꼭지점으로 하고, $(i, j)$를 우하단 꼭지점으로 하는 윈도우 내 모든 픽셀값들의 합이다.</p><p>Haar feature를 계산하는 과정은 (흰 영역의 모든 픽셀값의 합) - (검은 영역의 모든 픽셀값의 합) 으로 계산되는데, Haar filter 윈도우 크기가 큰 경우, 더해야 하는 픽셀 개수가 많아지기 때문에 연산에 부담이 되었었다. 하지만, integral image가 있으면, 윈도우 크기와 상관없이 매우 적은 수의 덧셈으로 Haar feature를 계산할 수 있다.</p><p>예를들어, 어떤 이미지에서, 다음 윈도우 크기 내 모든 픽셀값들의 합을 계산하고 싶다고 하자.</p><p><img src="https://user-images.githubusercontent.com/26874750/158171479-51544968-ac73-4a3e-a261-e6308d3b202d.png" alt="Untitled 5"></p><p>이 윈도우 내의 모든 픽셀값들의 합을 계산하는 과정은 픽셀 개수가 늘어남에 따라 연산량이 변한다. 또한, Haar filter 윈도우 크기는 기본적으로 크기 때문에, 연산해야 하는 덧셈 수는 매우 많다.</p><p>하지만, integral image가 있는 경우, 이야기가 달라진다. Integral image가 있는 경우, 위 그림에서의 윈도우 내의 모든 픽셀값을 계산하는 과정은 단 3번의 덧셈으로 가능하다. 윈도우 내의 모든 픽셀값의 합은 다음 integral image에서, $(a - b - c + d)$와 같다.</p><p><img src="https://user-images.githubusercontent.com/26874750/158171517-a4c73f74-8121-4373-941b-5e74b60b9800.png" alt="Untitled 6"></p><p>윈도우 내의 모든 픽셀값들의 합은 이처럼 단 세번의 덧셈으로 가능하며, 윈도우 크기가 크더라도 덧셈은 3번이면 충분하다. 다음 Haar filter를 이용하여 Haar feature를 계산하는 과정은 일곱번의 덧셈이면 충분하다.</p><p><img src="https://user-images.githubusercontent.com/26874750/158171552-55b3a77d-4efe-4bf3-98b9-85a9a6c0dd86.png" alt="Untitled 7"></p><p>위 그림에서 왼쪽 그림의 Haar filter를 이용하여 Haar feature를 계산하는 과정은, integral image에서 다음을 계산하는 것과 같다.</p><p>$$<br>\text{Haar Feature} = (b - c - e + f) - (a - b - d + e)<br>$$</p><p>Integral image가 있으면 Haar feature를 매우 적은 수의 덧셈으로 계산이 가능하다는 것을 알았는데, Integral image를 계산하는 과정이 복잡하면 의미가 없다. 하지만, integral image 역시 매우 빠르게 효율적으로 계산이 가능하다.</p><h3 id="Integral-Image-Computation"><a href="#Integral-Image-Computation" class="headerlink" title="Integral Image Computation"></a>Integral Image Computation</h3><p>Integral image를 계산하는 과정은 다음과 같다.</p><ol><li><p>Integral image $II$의 모든 픽셀값을 0으로 초기화한다.</p></li><li><p>Integral image의 $(1, 1)$ 좌표부터 $(h, w)$ 좌표(이미지 우하단 좌표)까지 왼쪽에서 오른쪽으로, 위에서 아래로 훑으면서 다음을 실행한다.</p><p>$$<br>II(i, j) = I(i, j) + II(i - 1, j) + II(i, j - 1) - II(i - 1, j - 1)<br>$$</p></li></ol><p>그림으로 표현하면 다음과 같다.</p><p><img src="https://user-images.githubusercontent.com/26874750/158171595-fa0b810f-54e4-4260-b295-8e2ee30aebf1.png" alt="Untitled 8"></p><p>연한 노랑색 부분은 이미 계산이 완료된 부분이며, 현재 $a$ 픽셀값에서의 integral image 값을 계산하고 있다고 하자. 이때, $b, c, d$는 이미 integral image 값이 계산이 완료되었다.</p><p>$a$ 위치에서의 integral image 값은 다음과 같이 계산된다.</p><p>$$<br>II(a) = I(a) + II(b) + II(c) - II(d)<br>$$</p><p>즉, 이미지의 모든 픽셀을 한번씩 쭉 훑으면 integral image가 계산된다. Integral image는 한 번 계산해놓으면 모든 Haar feature 계산에 이용할 수 있어서 매우 효율적이다.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Face detection이란, 이미지 또는 동영상에서 사람의 얼굴 부분을 찾아서 bounding box를 그려주는 작업을 말한다. 본 문서에서는 이러한 face detection이 어떻게 이루어지는지, face detection을 위해 사용되는
      
    
    </summary>
    
      <category term="Computer Vision" scheme="https://the-masked-developer.github.io/categories/Computer-Vision/"/>
    
    
      <category term="Computer Vision" scheme="https://the-masked-developer.github.io/tags/Computer-Vision/"/>
    
  </entry>
  
  <entry>
    <title>Binary Image Processing (Geometric Information)</title>
    <link href="https://the-masked-developer.github.io/wiki/binary-image-geometric-process/"/>
    <id>https://the-masked-developer.github.io/wiki/binary-image-geometric-process/</id>
    <published>2022-01-23T03:23:22.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<p># </p><h1 id="Geometric-Information"><a href="#Geometric-Information" class="headerlink" title="Geometric Information"></a>Geometric Information</h1><p>바이너리 이미지에서 추출할 수 있는 첫 번째 주요 정보는 객체에 대한 geometric 정보이다. 본 문서는 바이너리 이미지에서 추출할 수 있는 geometric 정보에 대해 다룬다.</p><h1 id="Geometric-Information-of-Binary-Images"><a href="#Geometric-Information-of-Binary-Images" class="headerlink" title="Geometric Information of Binary Images"></a>Geometric Information of Binary Images</h1><p>바이너리 이미지로 얻을 수 있는 이미지의 특징 중 하나는 이미지 내의 객체에 대한 geomatric 정보이다. 여기서, 객체의 geometric 정보란 다음과 같은 정보들을 말한다.</p><ul><li>이미지 내에서 객체의 넓이(area)</li><li>이미지 내에서 객체의 위치 좌표(coordinates)</li><li>이미지 내에서 객체의 방향(direction)</li></ul><p>이미지를 binarization할 수 있다면, 위와 같은 이미지의 geometric 특징을 추출할 수 있다.</p><h2 id="Area-of-Objects"><a href="#Area-of-Objects" class="headerlink" title="Area of Objects"></a>Area of Objects</h2><p>Gray-scale 이미지 $g$에 대해 추출한 바이너리 이미지를 $b$라고 할때, 이미지 속 객체의 넓이(area) $A$는 다음과 같이 계산할 수 있다.</p><p>$$<br>A = \int \int b(x, y) dx dy<br>$$</p><p>이때, $b(x, y)$는 $(x, y)$좌표에서의 픽셀의 바이너리 값으로 객체에 해당하는 픽셀만 1, 나머지 영역은 0이 된다.</p><p>하지만, 이미지 픽셀 사이의 공간은 discrete 이므로, 다음과 같이 객체의 넓이를 계산해야 한다.</p><p>$$<br>A = \sum_{x} \sum_{y} b(x, y)<br>$$</p><p>객체의 넓이는 이미지 내에서 객체가 움직이던, 회전하던 변하지 않는 특징이 될 수 있다(3차원적으로 회전하는 것 제외). 그러나, 이미지 내에 객체가 여러개인 경우, classification(or segmentation)을 먼저 수행할 필요가 있다.</p><p>참고로, 바이너리 이미지에서 객체의 넓이는 zero moment에 해당한다.</p><h2 id="Position-of-Objects"><a href="#Position-of-Objects" class="headerlink" title="Position of Objects"></a>Position of Objects</h2><p>바이너리 이미지 $b$에서, 객체에 해당하는 픽셀이 모두 1이고, 배경에 해당하는 픽셀이 모두 0일때, 객체의 중심 좌표는 다음과 같이 계산한다.</p><p>$$<br>\bar{x} = \frac{1}{A} \int \int x b(x, y) dx dy \<br>\bar{y} = \frac{1}{A} \int \int y b(x, y) dx dy<br>$$</p><p>이때, $A$는 객체의 넓이로, 바이너리 이미지에서 객체에 해당하는 픽셀의 개수이다.</p><p>역시, 픽셀공간이 discrete이기 때문에 다음과 같이 객체의 위치를 계산해야 한다.</p><p>$$<br>\bar{x} = \frac{1}{A} \sum_x \sum_y x b(x, y) \<br>\bar{y} = \frac{1}{A} \sum_x \sum_y y b(x, y)<br>$$</p><p>객체의 위치는 first moment에 해당한다.</p><h2 id="Direction-of-Objects"><a href="#Direction-of-Objects" class="headerlink" title="Direction of Objects"></a>Direction of Objects</h2><p>객체의 방향이란, 객체의 모양에서 가장 긴 축을 말한다. 예를들어, 다음 항아리 모양의 객체에서 객체의 방향은 그림의 축과 같다.</p><p><img src="https://user-images.githubusercontent.com/26874750/150641155-1fb06222-e384-49c1-be1b-e8eddbe80203.png" alt="Untitled"></p><p>바이너리 이미지에서 객체의 방향을 구하는 아이디어는 “2nd central moment가 가장 작은 축”을 구하는 것이다.</p><p>2nd central moment란, 어떤 축이 있을 때, 해당 축과 각 픽셀과의 거리의 제곱합을 의미하며, $(x, y)$좌표에 있는 점과 축과의 거리를 $r_{x, y}$라고 했을 때, 다음과 같이 정의된다.</p><p>$$<br>E = \int \int r_{x,y}^2 b(x, y) dx dy<br>$$</p><p>다음과 같은 두 개의 축을 생각해보자.</p><p><img src="https://user-images.githubusercontent.com/26874750/150641166-92b6aff4-d532-45c4-8324-52c890246c21.png" alt="Untitled 1"></p><p>왼쪽 그림에서는 객체의 모든 픽셀이 축과의 거리가 다 가까우므로 $E$ 값이 작다. 반면, 오른쪽 그림에서는 객체의 일부 픽셀이 축과의 거리가 상당히 먼 경우가 많기 때문에, $E$값이 커지게 된다. 즉, $E$값이 최소가 되는 축을 찾으면 객체의 방향 축을 찾을 수 있게 된다(PCA가 생각나는데?).</p><p>우리가 어떤 직선을 정의할때 보통 다음과 같이 직선의 방정식을 이용하게 된다.</p><p>$$<br>y = mx + b<br>$$</p><p>그러나, 이런 형태의 식에서는 $m$의 범위가 $-\infty$에서 $\infty$가 되기 때문에, 최적화가 좀 어렵다. 따라서, 위와 같은 직선의 방정식 말고 직선의 각도와 원점과의 거리를 이용하여 직선을 reparameterization하여 다음과 같이 정의한다.</p><p>$$<br>x \sin \theta - y \cos \theta + \rho = 0<br>$$</p><p>이때, $\theta$는 해당 직선과 $x$축 사이의 각도이며, $\rho$는 직선과 원점(0, 0) 사이의 거리이다.</p><p>이 직선과 $(x, y)$ 좌표의 픽셀 까지의 거리 $r_{x, y}$는 다음과 같다.</p><p>$$<br>r_{x, y} = \frac{|x \sin \theta - y \cos \theta + \rho|}{\sqrt{\sin^2 \theta + \cos^2 \theta}} = |x \sin \theta - y \cos \theta + \rho|<br>$$</p><p>이에 따라, 2nd central moment $E$는 다음과 같이 변형될 수 있다.</p><p>$$<br>E = \int \int |x \sin \theta - y \cos \theta + \rho|^2 b(x, y) dx dy<br>$$</p><p>우리가 원하는 것은 이 $E$를 최소화하는 축을 찾는 것이므로, $E$를 최소화하는 $\theta$와 $\rho$를 찾는 것이 우리가 계산해야 할 것이다.</p><p>위 $E$를 $\rho$에 대해 미분하여 0이 되는 “극점”을 찾아보자.</p><p>$$<br>\frac{d}{d\rho} E = \int \int 2 |x \sin \theta - y \cos \theta + \rho| b(x, y) dx dy = 0 \<br>= 2 (A \bar{x} \sin \theta - A \bar{y} \cos \theta + A \rho) = 0 \<br>2A (\bar{x} \sin \theta - \bar{y} \cos \theta + \rho) = 0<br>$$</p><p>이때, $A$는 객체의 넓이이고, $\bar{x}, \bar{y}$는 객체의 중심점 좌표이다. 객체의 넓이는 0이 아니므로, 직선 $x \sin \theta - y \cos \theta + \rho = 0$ 이 객체의 방향 축이 되려면 다음을 만족해야 한다.</p><p>$$<br>\bar{x} \sin \theta - \bar{y} \cos \theta + \rho = 0<br>$$</p><p>즉, 직선 $x \sin \theta - y \cos \theta + \rho = 0$는 객체의 중심 $(\bar{x}, \bar{y})$를 지나는 직선이어야 한다. 이것을 반영하여 직선을 다음과 같이 수정하자.</p><p>$$<br>(x - \bar{x}) \sin \theta - (y - \bar{y}) \cos \theta = 0<br>$$</p><p>이때, $E$를 다시 적어보면 다음과 같다.</p><p>$$<br>E = \int \int \vert x \sin \theta - y \cos \theta + \rho \vert^2 b(x, y) dx dy<br>$$</p><p>$$<br>= \int \int \vert(x - \bar{x}) \sin \theta - (y - \bar{y}) \cos \theta \vert^2 b(x, y) dx dy<br>$$</p><p>$$<br>= \int \int ((x - \bar{x})^2 \sin^2 \theta + (y - \bar{y})^2 \cos^2 \theta - 2(x - \bar{x})(y - \bar{y})\sin \theta \cos \theta) b(x, y) dx dy<br>$$</p><p>$$<br>= \sin^2 \theta \int (x - \bar{x})^2 dx+ \cos^2 \theta \int (y - \bar{y})^2 dy- 2 \sin \theta \cos \theta \int \int (x - \bar{x})(y - \bar{y}) dx dy<br>$$</p><p>이때, $\bar{x}, \bar{y}$는 쉽게 구할 수 있으므로, 맨 마지막 식의 integral은 간단하게(?) 계산이 가능하다. $E$식을 좀 간단하게 적기 위해 다음을 정의하자.</p><p>$$<br>a := \int (x - \bar{x})^2 dx \<br>b := \int (y - \bar{y})^2 dy \<br>c := \int \int (x - \bar{x})(y - \bar{y}) dx dy<br>$$</p><p>이때, $E$는 다음과 같이 변형할 수 있다.</p><p>$$<br>E = a \sin^2 \theta + b \cos^2 \theta - 2c \sin \theta \cos \theta<br>$$</p><p>이제, 이 식을 다시 $\theta$에 대해 미분하여 0이 되는 지점을 찾아 $E$의 “극점”을 구해보자.</p><p>$$<br>\frac{d}{d\theta} E = 2a\sin\theta \cos \theta - 2b \sin \theta \cos \theta - 2c(\cos^2 \theta - \sin^2 \theta) = 0 \<br>= (a - b) \sin 2\theta - 2c \cos 2\theta = 0 \<br>\tan 2 \theta = \frac{2c}{a - b}<br>$$</p><p>즉, 마지막 식이 만족할 때, $E$가 최소 또는 최대가 된다. 그런데, $0 \leq \theta \leq 2\pi$ 범위에서, 방정식의 해는 2개가 되는데, 어떤 $\theta_1$에 대해, $\tan 2 \theta_1 = \tan (2 \theta_1 + \pi)$ 이기 때문이다. 이때, 하나는 최소에 대한 해, 하나는 최대에 대한 해일 것인데, 2차 미분을 통해 어느 점이 최소점인지 찾아야 한다. $E$의 2차 미분은 다음과 같다.</p><p>$$<br>\frac{d^2}{d\theta^2} E = 2(a - b) \cos 2\theta + 4c \sin 2\theta<br>$$</p><p>이 식에 $\theta_1$와 $\theta_1 + \frac{1}{2}\pi$를 넣어보고, 2차미분값이 양의 값인 부분인 $\theta$를 찾으면 된다. 여기까지, 직선의 방정식의 파라미터 $\rho, \theta$를 구한 것이며, 객체의 방향 축을 구하는 과정이었다.</p><p>결과적으로, $\theta$는 다음과 같다.</p><p>$$<br>\theta = \frac{1}{2}\arctan\frac{2c}{a - b}<br>$$</p><p>## </p><h2 id="Roundness"><a href="#Roundness" class="headerlink" title="Roundness"></a>Roundness</h2><p>객체가 얼마나 둥글둥글한지를 측정하는 지표로, 2nd central moment $E$의 최댓값 $E_{\max}$과 최솟값 $E_{\min}$으로 구할 수 있다.</p><p>$$<br>\text{roundness} = \frac{E_{\min}}{E_{\max}}<br>$$</p><p>이 값이 1에 가까우면 객체가 둥글둥글 한 것이고, 0에 가까우면 객체가 길쭉한 타원에 가까운 것이다.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;# &lt;/p&gt;
&lt;h1 id=&quot;Geometric-Information&quot;&gt;&lt;a href=&quot;#Geometric-Information&quot; class=&quot;headerlink&quot; title=&quot;Geometric Information&quot;&gt;&lt;/a&gt;Geometric Inf
      
    
    </summary>
    
      <category term="Computer Vision" scheme="https://the-masked-developer.github.io/categories/Computer-Vision/"/>
    
    
      <category term="Computer Vision" scheme="https://the-masked-developer.github.io/tags/Computer-Vision/"/>
    
  </entry>
  
  <entry>
    <title>Intro to Binary Images</title>
    <link href="https://the-masked-developer.github.io/wiki/intro-to-binary-image/"/>
    <id>https://the-masked-developer.github.io/wiki/intro-to-binary-image/</id>
    <published>2022-01-23T03:22:22.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<p># </p><h1 id="Introduction-to-Binary-Images"><a href="#Introduction-to-Binary-Images" class="headerlink" title="Introduction to Binary Images"></a>Introduction to Binary Images</h1><p>바이너리 이미지란, 한개 또는 두 개의 숫자로만 이미지 값으로 존재하는 이미지를 말한다. 흔히, 완전 흰색과 완전 흑색으로만 구성되기도 한다. 바이너리 이미지는 다루기 쉬우면서도 이미지로부터 추출할 수 있는 매우 강건한 특징(feature)중 하나이다. 바이너리 이미지를 일단 얻게 되면, 이미지를 segmentation 하거나 분류하는 등의 작업을 수행할 수 있다.</p><h1 id="Binary-Images"><a href="#Binary-Images" class="headerlink" title="Binary Images"></a>Binary Images</h1><p>바이너리 이미지는 하나 또는 두 개의 값(보통 0과 1)으로 구성된 이미지이다.</p><p>바이너리 이미지 $b$는 gray-scale 이미지 $g$를 thresholding을 수행함으로서 얻을 수 있다.</p><ul><li>$g(x, y) &lt; T$ 이면, $b(x, y) = 0$</li><li>$g(x, y) \geq T$ 이면, $b(x, y) = 1$</li></ul><p>바이너리 이미지는 이미지 속 객체의 structure를 파악하는데 매우 중요한 역할을 할 수 있으며, 객체 segmentation을 매우 뛰어나게 수행할 수 있다는 장점이 있다.</p><p>하지만, threshold $T$를 주의깊게 설정해야 하는데, 너무 낮게 설정하면 모두 흰색인 바이너리 이미지가 얻어질 것이고, 너무 높게 설정하면 모두 검은색인 바이너리 이미지가 얻어질 것이다. Threshold를 정하는 방법은 임의로 정하는 방법도 있지만, color histogram을 이용하는 방법도 있다.</p><p>Color histogram을 이용하여 threshold를 정하는 방법은 이미지에서 foreground와 background가 명확하게 구분되는 이미지에서만 가능한데, 이러한 이미지에서 color histogram을 그린 후, color histogram의 골짜기 부분을 threshold로 삼는 것이다.</p><p><img src="https://user-images.githubusercontent.com/26874750/150640898-2e231d83-a220-4186-aab5-ff48e62ea3d4.png" alt="Untitled"></p><p>골짜기 부분을 threshold로 삼게 되면 foreground 객체는 하얗게, background 객체는 검게 binarize될 것이다.</p><p>이미지로부터 바이너리 이미지를 얻어내는 작업은 때로 어려울 수 있다. 배경이 다양하거나 객체의 색상 또는 명암이 배경과 비슷한 경우, threshold를 하나로 정하기 힘든 경우가 많다. 이 경우, 바이너리 이미지를 얻는 것 대신 다른 방법으로 이미지의 특징을 추출할 필요가 있다. 이처럼 바이너리 이미지를 계산할 수 있는 경우는 한정적이지만, 바이너리 이미지를 계산할 수 있다면, 매우 강건한 이미지의 특징을 얻을 수 있다.</p><p>바이너리 이미지로부터 추출할 수 있는 중요한 특징은 다음과 같이 크게 세 가지가 존재한다.</p><ol><li>객체에 대한 geometric 정보</li><li>객체에 대한 세그멘테이션 마스크</li><li>객체에 대한 구조적 정보(스켈레톤 등)</li></ol><p>이후 문서에서 위 세 가지 정보를 추출하는 방법에 대해 다루고자 한다.</p><ul><li><a href="https://the-masked-developer.github.io/wiki/binary-image-geometric-process/">Binary Image Processing (Geometric Information)</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;# &lt;/p&gt;
&lt;h1 id=&quot;Introduction-to-Binary-Images&quot;&gt;&lt;a href=&quot;#Introduction-to-Binary-Images&quot; class=&quot;headerlink&quot; title=&quot;Introduction to Binary I
      
    
    </summary>
    
      <category term="Computer Vision" scheme="https://the-masked-developer.github.io/categories/Computer-Vision/"/>
    
    
      <category term="Computer Vision" scheme="https://the-masked-developer.github.io/tags/Computer-Vision/"/>
    
  </entry>
  
  <entry>
    <title>업무시간에 몰래 작성해보는 springboot jpa entity와 dto</title>
    <link href="https://the-masked-developer.github.io/wiki/%5Bspringboot%5Djpa-dto-basic/"/>
    <id>https://the-masked-developer.github.io/wiki/[springboot]jpa-dto-basic/</id>
    <published>2021-12-15T08:50:00.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h3 id="JPA-JpaRepository-소개"><a href="#JPA-JpaRepository-소개" class="headerlink" title="JPA, JpaRepository 소개"></a>JPA, JpaRepository 소개</h3><hr><p>JPA란?  </p><ul><li>Java ORM 기술 표준으로 사용하는 인터페이스 모음  </li></ul><p>JpaRepository란?  </p><ul><li>Spring, SpringBoot Framework에서 제공하는 인터페이스<ul><li>QueryByExampleExecutor와 PagingAndSortingRepository를 상속함</li><li>기본적인 수준의 검색 메서드가 정의되어 있어서 override하여 사용 가능</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">ID</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">PagingAndSortingRepository</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">ID</span>&gt;, <span class="hljs-title">QueryByExampleExecutor</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * (non-Javadoc)</span><br><span class="hljs-comment"> * @see org.springframework.data.repository.CrudRepository#findAll()</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function">List&lt;T&gt; <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * (non-Javadoc)</span><br><span class="hljs-comment"> * @see org.springframework.data.repository.PagingAndSortingRepository#findAll(org.springframework.data.domain.Sort)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function">List&lt;T&gt; <span class="hljs-title">findAll</span><span class="hljs-params">(Sort sort)</span></span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * (non-Javadoc)</span><br><span class="hljs-comment"> * @see org.springframework.data.repository.CrudRepository#findAll(java.lang.Iterable)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function">List&lt;T&gt; <span class="hljs-title">findAllById</span><span class="hljs-params">(Iterable&lt;ID&gt; ids)</span></span>;<br><br>...<br></code></pre></td></tr></table></figure><h3 id="Entity와-Dto"><a href="#Entity와-Dto" class="headerlink" title="Entity와 Dto"></a>Entity와 Dto</h3><hr><p>다음과 같은 테이블 Coupon 있다고 하자</p><table><thead><tr><th>Column</th><th>Type</th><th>Default Value</th><th>Nullable</th><th>그 외</th></tr></thead><tbody><tr><td>no</td><td>int</td><td></td><td>NO</td><td>Primary Key, Auto Increment</td></tr><tr><td>coupon_no</td><td>varchar</td><td></td><td>NO</td><td>쿠폰번호</td></tr><tr><td>use_date</td><td>timestamp</td><td></td><td>YES</td><td>사용일자</td></tr><tr><td>use_flag</td><td>enum(‘Y’,’N’)</td><td>N</td><td>NO</td><td>사용여부</td></tr><tr><td>discount</td><td>int</td><td>0</td><td>NO</td><td>할인가격</td></tr><tr><td>description</td><td>varchar</td><td></td><td>YES</td><td>쿠폰 설명</td></tr><tr><td>discount_type</td><td>enum(‘P’, ‘W’)</td><td>W</td><td>NO</td><td>할인 방식 (‘P’ : 퍼센티지, ‘W’ : 원)</td></tr><tr><td>create_date</td><td>timestamp</td><td>CURRENT_TIMESTAMP</td><td>NO</td><td>Default Generated 생성 일자</td></tr></tbody></table><p>Entity는 해당 테이블과 매핑하여 사용<br>Dto는 테이블에서 받은 Entity를 다른 layer로 전송할때 사용 (Data Transfer Object)</p><p>entity와 dto는 다음과 같이 만들 수 있다.</p><p>ENTITY</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> entity;<br><br><span class="hljs-keyword">import</span> enums.DiscountType;<br><span class="hljs-keyword">import</span> enums.YorN;<br><span class="hljs-keyword">import</span> lombok.*;<br><span class="hljs-keyword">import</span> org.hibernate.annotations.CreationTimestamp;<br><span class="hljs-keyword">import</span> javax.persistence.*;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-meta">@ToString</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@Setter</span><br><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name=&quot;coupon&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Coupon</span> </span>&#123;<br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span><br>    <span class="hljs-meta">@Column(name = &quot;no&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> no;<br><br>    <span class="hljs-meta">@Column(name = &quot;coupon_no&quot;)</span><br>    <span class="hljs-keyword">private</span> String couponNo;<br><br>    <span class="hljs-meta">@Column(name = &quot;use_date&quot;)</span><br>    <span class="hljs-meta">@Builder</span>.Default<br>    <span class="hljs-keyword">private</span> LocalDateTime useDate = <span class="hljs-keyword">null</span>;<br><br>    <span class="hljs-meta">@Enumerated(EnumType.STRING)</span>    <span class="hljs-comment">// EnumType은 ORDINAL과 STRING이 있음     </span><br>    <span class="hljs-meta">@Builder</span>.Default                <span class="hljs-comment">// Builder로 생성 시 default 값 설정</span><br>    <span class="hljs-meta">@Column(name = &quot;use_flag&quot;)</span><br>    <span class="hljs-keyword">private</span> YorN useFlag = YorN.N; <span class="hljs-comment">// 설정될 default값 (&#x27;N&#x27;)</span><br><br>    <span class="hljs-meta">@Column(name = &quot;discount&quot;)</span><br>    <span class="hljs-meta">@Builder</span>.Default<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> discount = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-meta">@Column(name = &quot;description&quot;, nullable = true)</span><br>    <span class="hljs-keyword">private</span> String description;<br><br>    <span class="hljs-meta">@Enumerated(EnumType.STRING)</span><br>    <span class="hljs-meta">@Column(name = &quot;discount_type&quot;)</span><br>    <span class="hljs-meta">@Builder</span>.Default<br>    <span class="hljs-keyword">private</span> DiscountType discountType = DiscountType.W;<br><br>    <span class="hljs-meta">@CreationTimestamp</span><br>    <span class="hljs-meta">@Column(name= &quot;create_date&quot;, columnDefinition = &quot;TIMESTAMP&quot;)</span><br>    <span class="hljs-keyword">private</span> LocalDateTime createDate;<br>&#125;<br></code></pre></td></tr></table></figure><p>DTO</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> dto;<br><br><span class="hljs-keyword">import</span> enums.DiscountType;<br><span class="hljs-keyword">import</span> enums.YorN;<br><span class="hljs-keyword">import</span> entity.Coupon;<br><span class="hljs-keyword">import</span> lombok.*;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@Setter</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CouponDto</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> no;<br>    <span class="hljs-keyword">private</span> String couponNo;<br>    <span class="hljs-keyword">private</span> LocalDateTime useDate;<br>    <span class="hljs-keyword">private</span> YorN useFlag;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> discountPrice;<br>    <span class="hljs-keyword">private</span> DiscountType discountType;<br>    <span class="hljs-keyword">private</span> String description;<br>    <span class="hljs-keyword">private</span> LocalDateTime createDate;<br><br>    <span class="hljs-meta">@Builder(builderMethodName = &quot;CouponDtoBuilder&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CouponDto</span><span class="hljs-params">(Coupon coupon)</span></span>&#123;<br>        no = coupon.getNo();<br>        couponNo = coupon.getCouponNo();<br>        useDate = coupon.getUseDate();<br>        useFlag = coupon.getUseFlag();<br>        discountPrice = coupon.getDiscount();<br>        discountType = coupon.getDiscountType();<br>        description = coupon.getDescription();<br>        createDate = coupon.getCreateDate();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ENUM</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> enums;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonValue;<br><span class="hljs-keyword">import</span> java.util.Locale;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">DiscountType</span> </span>&#123;<br>    P, W;<br><br>    <span class="hljs-meta">@JsonValue</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name().toUpperCase(Locale.ROOT); &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">YorN</span> </span>&#123;<br>    Y, N;<br><br>    <span class="hljs-meta">@JsonValue</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name().toUpperCase(Locale.ROOT); &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>@Enumerated(EnumType)의 경우, ORDINAL과 STRING이 존재</p><ul><li>ORDINAL - P : 1, W : 2 … enum의 순서가 DB에 저장됨</li><li>STRING - P, W … enum의 문자열 값이 DB에 저장됨</li></ul><p>JpaRepository를 상속하는 CouponRepository를 다음과 같이 생성하고</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> repository;<br><br><span class="hljs-keyword">import</span> entity.Coupon;<br><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;<br><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CouponRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">Coupon</span>, <span class="hljs-title">Integer</span>&gt; </span>&#123;<br>    <span class="hljs-function">Coupon <span class="hljs-title">findCouponByNo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> no)</span></span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Service Layer에서는 다음과 같이 DTO로 사용할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> service;<br><br><span class="hljs-keyword">import</span> dto.CouponDto;<br><span class="hljs-keyword">import</span> entity.Coupon;<br><span class="hljs-keyword">import</span> repository.CouponRepository;<br><span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CouponService</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CouponRepository couponRepository;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> CouponDto <span class="hljs-title">getCouponInfoByNo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> no)</span> </span>&#123;<br>        Coupon coupon = couponRepository.findCouponByNo(no);<br><br>        CouponDto couponDto = CouponDto.CouponDtoBuilder().coupon(coupon).build();<br><br>        <span class="hljs-comment">// Do Something</span><br><br>        <span class="hljs-keyword">return</span> couponDto;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;JPA-JpaRepository-소개&quot;&gt;&lt;a href=&quot;#JPA-JpaRepository-소개&quot; class=&quot;headerlink&quot; title=&quot;JPA, JpaRepository 소개&quot;&gt;&lt;/a&gt;JPA, JpaRepository 소개&lt;/h3
      
    
    </summary>
    
      <category term="java" scheme="https://the-masked-developer.github.io/categories/java/"/>
    
      <category term="springboot" scheme="https://the-masked-developer.github.io/categories/java/springboot/"/>
    
    
      <category term="java" scheme="https://the-masked-developer.github.io/tags/java/"/>
    
      <category term="springboot" scheme="https://the-masked-developer.github.io/tags/springboot/"/>
    
  </entry>
  
  <entry>
    <title>RESTful API design.</title>
    <link href="https://the-masked-developer.github.io/wiki/restful-api-design/"/>
    <id>https://the-masked-developer.github.io/wiki/restful-api-design/</id>
    <published>2021-12-02T05:11:45.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h2 id="RESTful-API-design’s-Goals"><a href="#RESTful-API-design’s-Goals" class="headerlink" title="RESTful API design’s Goals."></a>RESTful API design’s Goals.</h2><ol><li>Platform indenpendency.</li><li>Self-evolution.</li></ol><blockquote><p>굳이 HTTP 일 필요는 없다. design 의 문제.</p></blockquote><h2 id="Design-Principles"><a href="#Design-Principles" class="headerlink" title="Design Principles."></a>Design Principles.</h2><ol><li>Resource 를 중심으로 설계된다. <ul><li>Resource 는 고유의 identifier 를 가진다.</li></ul></li><li>Representation 을 가진다. 보통 JSON.</li><li>각 Request 는 Stateless, Atomic, Indenpendent 하다. <ul><li>Server 의 scale out 을 가능케 한다.</li><li>Indenpendent 하기 때문에 요청의 순서에 신경쓰지 않아도 된다.</li></ul></li></ol><h2 id="Maturity-of-RESTful-HTTP-API"><a href="#Maturity-of-RESTful-HTTP-API" class="headerlink" title="Maturity of RESTful HTTP API."></a>Maturity of RESTful HTTP API.</h2><ol><li>POST only.</li><li>Resource + URI 분리</li><li>Resource + HTTP methods.</li><li>HATEOAS (+hyperlinks)</li></ol><blockquote><p>보통, 대부분의 RESTful HTTP API 는 2 ~ 3 그 어딘가에 있다.</p></blockquote><h2 id="Design-guide"><a href="#Design-guide" class="headerlink" title="Design guide."></a>Design guide.</h2><ol><li>No verbs. (Use methods for it!)</li><li>There’s no need to match with database schema. (just abstract it. hide implementation.)</li><li>resource 의 collection 들은 다른 URI 를 가진다. <ul><li>ex) <code>/orders</code></li></ul></li><li>Resource 의 relationship 은 hierachy 하게 표현한다. <ul><li>ex) <code>/customers/&#123;customer_id&#125;/orders/&#123;order_id&#125;</code>…</li><li>관계가 너무 많으면 관리가 힘들다. 그러므로 여러번 요청을 날린다던지 너무 계층이 많아지지 않도록 조심한다.</li></ul></li><li>chatty 한 API design 보다는, 하나의 큰 load 를 가진 API 가 낫다. (denormalized API is better) <ul><li>지나친 Overfetching 은 조심해야 한다.</li></ul></li><li>Abstract database schema. do not expose it.</li><li>Resource 와 관련없는 서버의 function, procedure 를 실행해야 할 경우도 있다. 적당히 사용한다.</li></ol><h3 id="HTTP-methods"><a href="#HTTP-methods" class="headerlink" title="HTTP methods."></a>HTTP methods.</h3><ol><li><code>GET</code>: Resource’s representation. <ul><li><code>200</code></li><li><code>404</code></li></ul></li><li><code>POST</code>: Resource’s creation or call server’s function. <ul><li><code>201</code>: creation success.</li><li><code>200</code>: no creation.</li><li><code>400</code>: bad representation.</li><li>생성시 <code>Location</code> Header 에 resource 의 ID 를 담아서 리턴한다.</li></ul></li><li><code>PUT</code>: Create or update resource (w/ complete representation) <ul><li><code>201</code>, <code>200</code>, <code>400</code></li><li><code>409</code>(Conflict): Valid 한 요청이지만, Server 의 state 로 인해 update 를 실패했다.</li><li>생성의 경우 Client 가 적절하게 좋은 ID 를 생성할 수 있어야 한다.</li></ul></li><li><code>PATCH</code>: Update resource partially <ul><li><code>200</code>, <code>400</code>, <code>409</code> </li><li>Representation fields are optional.</li><li><code>null</code> means delete the field’s value.</li></ul></li><li><code>DELETE</code>: Delete resource. <ul><li><code>204</code>(No Content): success</li></ul></li></ol><h3 id="Filter-and-Pagination"><a href="#Filter-and-Pagination" class="headerlink" title="Filter and Pagination"></a>Filter and Pagination</h3><p>TBW. <a href="https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design#filter-and-paginate-data">https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design#filter-and-paginate-data</a></p><h3 id="Versioning"><a href="#Versioning" class="headerlink" title="Versioning"></a>Versioning</h3><ol><li>No versioning. acceptable for internal APIs.</li><li>Header versioning. <ul><li>ex) <code>App-Version: ...</code></li></ul></li><li>Query string versioning. <ul><li>ex) <code>/...?version=1</code></li></ul></li><li>URI versiong. <ul><li>ex) <code>/v1/...</code>.</li></ul></li><li>media type versioning.</li></ol><h2 id="Open-API"><a href="#Open-API" class="headerlink" title="Open API"></a>Open API</h2><p>TBW. <a href="https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design#open-api-initiative">https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design#open-api-initiative</a></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design">Microsoft RESTful API best practices</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;RESTful-API-design’s-Goals&quot;&gt;&lt;a href=&quot;#RESTful-API-design’s-Goals&quot; class=&quot;headerlink&quot; title=&quot;RESTful API design’s Goals.&quot;&gt;&lt;/a&gt;RESTful
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Distributed Programming in PyTorch</title>
    <link href="https://the-masked-developer.github.io/wiki/distributed-programming-in-pytorch/"/>
    <id>https://the-masked-developer.github.io/wiki/distributed-programming-in-pytorch/</id>
    <published>2021-11-30T13:22:10.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Distributed-Programming-in-PyTorch"><a href="#Distributed-Programming-in-PyTorch" class="headerlink" title="Distributed Programming in PyTorch"></a>Distributed Programming in PyTorch</h1><p>PyTorch는 멀티 GPU 학습을 위해 <code>torch.nn.DataParallel</code>을 제공한다. 이 클래스의 사용법은 상당히 간단한데, 모델을 만든 후, <code>torch.nn.DataParallel</code>을 씌워주면 된다. 예를들어, 다음과 같다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Model</span>(<span class="hljs-params">nn.Module</span>):</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br><span class="hljs-comment"># ...</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, x</span>):</span><br><span class="hljs-comment"># ...</span><br><br>model = Model().cuda()<br>dmodel = nn.DataParallel(model).cuda()<br><br><span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(EPOCHS):<br><span class="hljs-keyword">for</span> x, y <span class="hljs-keyword">in</span> trainloader:<br>logps = dmodel(x)   <span class="hljs-comment"># 여기서, model 대신, dmodel을 사용하면 됨</span><br>  <span class="hljs-comment"># dmodel은 x를 GPU개수만큼 잘라서 각각 돌리고</span><br><span class="hljs-comment"># 그 결과를 concat해서 반환해줌</span><br><br><span class="hljs-comment"># loss 계산, acc 계산, back-prop 등등 처리</span><br></code></pre></td></tr></table></figure><p>이처럼, <code>Model</code>이 들어가야 할 자리에 <code>torch.nn.DataParallel</code> 객체를 넣어주면 된다. 매우 간편하게 멀티 GPU를 사용할 수 있는 셈이다.</p><p>하지만, 이 <code>torch.nn.DataParallel</code> 은 치명적인 문제점이 존재한다.</p><ul><li><p><code>torch.nn.DataParallel</code>은 Thread 기반이다.</p><ul><li><p>아시는분들은 아시겠지만, python의 멀티스레드 프로그래밍에서는 GIL이라는 큰 제약조건이 존재한다.</p><aside>💡 GIL(Global Interpreter Lock)이란, 파이썬 인터프리터의 구현 모델중 하나로, 파이썬 인터프리터의 동기화 문제 등으로 인해, 동시에 구동될 수 있는 파이썬 스레드 개수를 최대 1개로 제한해버린 구현 모델을 말한다. 즉, 파이썬 코드로 스레드를 많이 만들어서 코드를 구동하고, 컴퓨터에 프로세서가 많다고 해도, 파이썬은 한 번에 하나의 스레드만 돌린다.</aside></li></ul></li></ul><p>따라서, <code>torch.nn.DataParallel</code>을 사용한다고 해서, GPU가 늘어나는 만큼 그 속도가 증가하지는 못한다. PyTorch에는 이러한 문제를 해결하기 위해 <code>torch.nn.parallel.DistributedDataParallel</code> 이라는 클래스를 제공한다.</p><p><code>torch.nn.parallel.DistributedDataParallel</code>은 스레드기반이 아닌 프로세스 기반이다. 파이썬에서는 <code>threading</code>이라는 모듈을 제공하지만, 말했다시피, GIL으로 인해 <code>threading</code>의 성능은 그렇게 좋지 못하다. 파이썬에서는 다행히도 GIL을 피할 수 있게 <code>multiprocessing</code>이라는 모듈을 standard library로 제공하고 있다.</p><p>PyTorch에서는 이 파이썬 <code>multiprocessing</code> 모듈처럼, <code>torch.multiprocessing</code> 모듈과 <code>torch.distributed</code> 모듈을 제공하며, 이는 스레드 기반 분산처리보다 더 나은 분산처리를 구현하는 데 사용될 수 있다. 우리가 여기서 논의할 내용이 바로 PyTorch에서 제공하는 프로세스 기반 분산 프로그래밍이다.</p><h1 id="Distributed-Programming-in-PyTorch-1"><a href="#Distributed-Programming-in-PyTorch-1" class="headerlink" title="Distributed Programming in PyTorch"></a>Distributed Programming in PyTorch</h1><p>여기서 논의할 내용은 다음과 같다.</p><ol><li>PyTorch에서의 프로세스 생성 방법</li><li>PyTorch의 프로세스 그룹과 <code>init_process_group</code> 함수</li><li>PyTorch 프로세스간의 blocking 통신</li><li>PyTorch 프로세스간의 non-blocking 통신</li></ol><p><code>torch.nn.parallel.DistributedDataParallel</code>의 경우, 여기서 다루지는 않고, 나중에 다른 문서에서 다루도록 할 것이다. 본 문서에서는 <code>torch.nn.parallel.DistributedDataParallel</code>를 공부하기 이전에 PyTorch에서 어떻게 프로세스 단위로 프로그래밍할 수 있는지 알아볼 것이다.</p><h2 id="Process-Creation-in-PyTorch"><a href="#Process-Creation-in-PyTorch" class="headerlink" title="Process Creation in PyTorch"></a>Process Creation in PyTorch</h2><p>PyTorch에서는 <code>torch.multiprocessing</code>이라는 모듈을 제공하는데, 파이썬 standard library에서의 <code>multiprocessing</code> 모듈과 유사하게 생겼다.</p><p>PyTorch에서 프로세스를 생성하는 방법은 다음과 같다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.multiprocessing <span class="hljs-keyword">import</span> Process<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>(<span class="hljs-params">args</span>):</span><br><span class="hljs-comment"># ...</span><br><br>args = []                                <span class="hljs-comment"># func에 넘겨줄 인자 리스트</span><br>p = Process(target=func, args=args)      <span class="hljs-comment"># 프로세스 생성. 이때, 아직,</span><br> <span class="hljs-comment"># 프로세스는 시작하지 않음(func을 구동하지 않음)</span><br><br>p.start()                                <span class="hljs-comment"># 여기서 비로소 프로세스 시작</span><br>p.join()                                 <span class="hljs-comment"># 프로세스가 끝날때까지 기다리고 자원 회수</span><br></code></pre></td></tr></table></figure><p>이 형태는 파이썬 <code>threading</code> 라이브러리 사용법과도 매우 유사한데, PyTorch에서 프로세스를 생성하는 방법은 <code>Process</code> 객체를 생성하는 것이다. 이때, <code>Process</code> 생성자로 넘겨주는 파라미터 중 가장 중요한 두 개의 인자는 바로 <code>target</code>과 <code>args</code>이다. <code>target</code>인자는 해당 프로세스가 생성되고 실행할 함수를 의미하며, <code>args</code>는 그 함수에 넘겨줄 파라미터를 받는다. 여기서, <code>target</code>은 <code>func</code>으로 설정되어 있기 때문에, 프로세스는 시작할 때, <code>func</code> 함수를 실행하게 되며, <code>args</code>라는 파라미터를 <code>func</code>의 파라미터로 넘겨주게 된다.</p><p><code>Process</code> 를 통해 프로세스를 생성한다고 해서 프로세스가 바로 시작하지는 않는다. <code>Process</code> 객체의 <code>start</code> 메소드를 호출해야 해당 프로세스가 비로소 <code>target</code>함수를 실행하게 된다.</p><p>Linux 시스템 프로그래밍 경험이 있으시다면, <code>join</code>함수의 중요성을 잘 알 것이다. 기본적으로 프로세스를 코드상에서 생성하게 되면, 그 프로세스는 코드를 구동하는 프로세스의 자식 프로세스로 생성된다. <strong>그리고, 이것은, 코드를 실행하는 프로세스가 자식 프로세스의 자원을 회수할 의무가 있다는 것을 의마한다.</strong></p><p>코드상에서 <code>fork</code>, <code>Process</code>와 같은 코드를 사용하여 프로세스를 생성했다면, 코드에서 그 프로세스의 죽음을 지켜보고 그 자원을 회수할 의무가 있다. <strong>그 역할을 하는 함수가 바로 <code>join</code>이다.</strong> 만약, 코드를 실행하는 프로세스가 자식을 회수하지 않고 끝나버리면, 그 자식 프로세스는 데몬 프로세스가 되는데, 물론, 요즘 운영체제는 부모가 죽으면, 그 자식의 자원을 자동으로 회수해주긴 하지만, 명시적으로 <code>join</code>을 호출해주는 습관을 들이는게 좋다.</p><h2 id="Process-Group"><a href="#Process-Group" class="headerlink" title="Process Group"></a>Process Group</h2><p>PyTorch의 멀티프로세싱에서는 프로세스 그룹이라는 개념이 있다. 프로세스 그룹이란, 말 그대로 여러 프로세스를 묶어 관리하는 것을 말하는데, 프로세스 그룹 안에 속해있는 프로세스들은 peer 프로세스가 몇개가 있고 누가 있는지 알 수 있다. 즉, 그에따라, peer 프로세스와 통신이 가능하다.</p><p>프로세스 그룹은 처음볼때는 이해하기가 좀 까다로운데, 프로세스 그룹이 형성되는 과정은 다음과 같다.</p><ol><li>루트프로세스에서 여러개의 자식 프로세스를 생성한다.</li><li>각 자식 프로세스에서, 마스터(프로세스 중 하나를 마스터로 삼는다)의 주소를 알 수 있게 하는 환경변수를 설정한다.<ul><li><code>MASTER_ADDR</code>: 마스터의 ip주소</li><li><code>MASTER_PORT</code>: 마스터의 포트번호</li></ul></li><li>개발자는 각 자식 프로세스 코드에서 <code>init_process_group</code> 함수를 호출하여, 해당 프로세스가 프로세스 그룹에 속한다는 것을 알려주어야 한다.<ul><li>즉, <code>init_process_group</code>은 해당 프로세스에게, 그룹에 소속되어있다는 사실을 알려주는 함수이다.</li><li><code>init_process_group</code>이 실행되면, 해당 프로세스는 <code>MASTER_ADDR</code>와 <code>MASTER_PORT</code>를 사용하여 마스터와 통신을 시도한다.</li><li>마스터는 여러 프로세스로부터 통신을 받게 되며, 마스터는 그 프로세스들을 서로 통신할 수 있도록 연결시켜준다.</li></ul></li></ol><p>여기서, 알아두어야 할 점은, <code>init_process_group</code>함수는 <strong>프로세스를 생성하지는 않는다</strong>. 프로세스 그룹을 생성하는 역할을 하는 것이다. 또한, <strong>다른 peer 프로세스가 누가 있는지, 알 수 있게 해 주는 함수가 바로 <code>init_process_group</code>이며</strong>, 즉, 다른 peer 프로세스의 존재를 알려줌으로써, 나중에 peer 프로세스와 메시지를 주고받을 수 있게 해 주는 함수도 <code>init_process_group</code>이다.</p><h3 id="Example-of-init-process-group"><a href="#Example-of-init-process-group" class="headerlink" title="Example of init_process_group"></a>Example of <code>init_process_group</code></h3><p>다음은 <code>init_process_group</code>를 사용하는 예제코드를 보여준다(Reference: <a href="https://pytorch.org/tutorials/intermediate/dist_tuto.html#point-to-point-communication">PyTorch 공식홈피</a>).</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.distributed <span class="hljs-keyword">as</span> dist<br><span class="hljs-keyword">from</span> torch.multiprocessing <span class="hljs-keyword">import</span> Process<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">rank, size</span>):</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">프로세스가 실행하는 메인 함수</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># some logic</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_process</span>(<span class="hljs-params">rank, size, fn, backend=<span class="hljs-string">&quot;gloo&quot;</span></span>):</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">이 함수는 각 프로세스에서 실행되는 함수이다.</span><br><span class="hljs-string">이 함수는 각 프로세스가 만들어졌을 때, 프로세스 그룹을</span><br><span class="hljs-string">세팅하기 위한 함수로, 세팅이 끝나면, 마지막으로 메인 함수인 run을 호출한다.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;I am a <span class="hljs-subst">&#123;rank&#125;</span> process!&quot;</span>)<br><br><span class="hljs-comment"># 각 프로세스에서는 MASTER_ADDR와 MASTER_PORT 환경변수를 설정해준다.</span><br>os.environ[<span class="hljs-string">&quot;MASTER_ADDR&quot;</span>] = <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>os.environ[<span class="hljs-string">&quot;MASTER_PORT&quot;</span>] = <span class="hljs-string">&quot;24500&quot;</span><br><br><span class="hljs-comment"># 이 프로세스는 127.0.0.1:24500 을 마스터로 하는 프로세스 그룹에 속한다는 것을</span><br><span class="hljs-comment"># 알려준다.</span><br>dist.init_process_group(backend, rank=rank, world_size=size)<br><br><span class="hljs-comment"># fn 함수 호출</span><br>fn(rank, size)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br><span class="hljs-comment"># GPU 개수 얻어오기</span><br>size = torch.cuda.device_count()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Device count:&quot;</span>, size)<br><br>processes = []<br><br><span class="hljs-comment"># GPU개수만큼 프로세스 생성 후 각 프로세스에서 init_process 구동</span><br><span class="hljs-keyword">for</span> rank <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size):<br>p = Process(target=init_process, args=(rank, size, run))<br>p.start()<br>processes.append(p)<br><br><span class="hljs-comment"># 모든 자식이 죽을때까지 기다렸다가 자원 회수</span><br><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:<br>p.join()<br></code></pre></td></tr></table></figure><p>각 프로세스가 생성되면, <code>init_process</code>라는 함수가 호출되는데, <code>init_process</code>는 해당 프로세스의 환경변수를 세팅하고 프로세스 그룹에 포함된다는 사실을 알려주는(즉, <code>init_process_group</code>을 호출하는) 역할을 수행하는 함수이다. 이러한 세팅이 끝나면, 곧이어 <code>run</code> 함수를 호출하게 되고, <code>run</code> 함수에서 로직을 수행하게 되는 것이다.</p><p><code>init_process_group</code>함수를 자세히 살펴보자. <code>init_process_group</code>은 많은 파라미터를 받을 수 있지만, 이 예제에서는 <code>backend</code>, <code>world_size</code>, <code>rank</code> 세 가지의 파라미터만 사용한다. 다음은 <code>init_process_group</code>의 각 파라미터에 대한 설명이다.</p><ul><li><p><code>backend</code> 파라미터</p><ul><li>PyTorch에서 프로세스 그룹을 생성한다는 것은 여러 프로세스가 서로 통신하며 분산처리를 하겠다는 것을 의미한다. 따라서, 분산처리 백엔드 라이브러리를 사용해야 하며, <code>backend</code> 파라미터는 어떤 백엔드를 사용하여 분산처리를 할 것인지 명시하도록 한다.</li><li>PyTorch는 scratch부터 low-level부터 high-level까지의 분산처리 시스템을 구현한 것이 아니라, 다른 low-level 분산처리 라이브러리를 가저다 쓰는 형태이다. 즉, 백엔드는 다른 라이브러리를 사용한다. PyTorch에서는 세 가지의 백엔드를 지원한다.<ul><li><strong>GLOO</strong>: PyTorch에서 가장 잘 지원하는 라이브러리로, CPU 텐서와 GPU 텐서의 분산처리 모두를 지원한다. 다만, GPU 텐서 연산의 경우 NCCL 백엔드보다는 최적화가 덜 되어 있다고 한다.</li><li><strong>MPI</strong>: Messaging passing interface를 사용하는 백엔드. 이것을 백엔드로 쓰려면, MPI 라이브러리의 추가적인 설치와 세팅이 필요하다. 자세한것은 <a href="https://pytorch.org/tutorials/intermediate/dist_tuto.html#communication-backends">여기</a> 참고</li><li><strong>NCCL</strong>: GPU 텐서연산에 대해 고도로 최적화된 백엔드이다. GPU에 올라간 텐서만 통신을 지원한다.</li></ul></li></ul></li><li><p><code>world_size</code> 파라미터</p><ul><li><p>해당 프로세스 그룹에 속할 프로세스의 총 개수를 의미하며, 각 프로세스에게 몇 개의 peer 프로세스가 있는지 알 수 있도록 해 주는 인자이다.</p></li><li><p>프로세스가 마스터와 통신할때, 몇 개의 peer 프로세스가 접속하기를 기다려야 하는지 알려주는 인자이기도 하다. 즉, 프로세스가 <code>init_process_group</code>을 호출하게 되면, 마스터와 통신을 시도하고, 마스터는 그 프로세스에게 다른 peer 프로세스를 연결시켜 주는데, <code>world_size</code> 파라미터를 명시해주게 되면,  몇 개의 peer 프로세스가 자신과 연결되어야 하는지 알 수 있게 된다(<code>world_size - 1</code>개의 프로세스가 자신과 연결되어야 함).</p><p>  만약, 마스터가 자신에게 <code>world_size - 1</code>개의 프로세스를 아직 연결해주지 못했다면(다른 peer 프로세스가 아직 <code>init_process_group</code>을 호출하지 못했다거나의 이유로)  해당 프로세스는 마스터와 계속 연결을 유지하면서 peer를 기다린다.</p></li></ul></li><li><p><code>rank</code> 파라미터</p><ul><li><p>해당 프로세스의 id값이라고 보면 된다.</p></li><li><p>프로세스 그룹이 생성될때, 각 프로세스는 rank의 값으로 자신의 id를 설정한다. 이 값은 나중에 다른 프로세스와 통신할때 사용된다.</p><p>  즉, 3번 rank를 가진 프로세스에게 tensor를 전송하라! 라는 명령이 가능하다.</p></li></ul></li></ul><p><code>os.environ[&quot;MASTER_ADDR&quot;]</code>와 <code>os.environ[&quot;MASTER_PORT&quot;]</code>의 설정, 그리고, <code>init_process_group</code>은 각각의 프로세스에서 모두 한번씩 실행되어야 함을 주의해야 한다.</p><h2 id="Blocking-Communications-in-PyTorch"><a href="#Blocking-Communications-in-PyTorch" class="headerlink" title="Blocking Communications in PyTorch"></a>Blocking Communications in PyTorch</h2><p><code>init_process_group</code>을 이용하여 각각의 프로세스에게 peer 프로세스가 누가 있는지 알려줄 수 있었다. <code>init_process_group</code>을 통해 peer 프로세스가 누군지 알 수 있게 되면, peer 프로세스의 rank 번호를 이용하여 peer 프로세스와 통신이 가능하다.</p><p>통신에는 blocking 통신과 non-blocking 통신이 존재하는데, 먼저, blocking 통신에 대해 논의해보도록 한다.</p><p>PyTorch에서의 다른 프로세스와의 통신은, 텐서를 주고받는 것이다. 텐서를 보내는 함수로는 <code>torch.distributed.send</code>가 있고, 텐서를 받는 함수로는 <code>torch.distributed.recv</code>가 있다.</p><p><code>torch.distributed.send</code>를 호출하게 되면, 상대방 프로세스가 <code>recv</code>를 호출하여 받을 때까지 blocking된다. 마찬가지로, <code>torch.distributed.recv</code>를 호출하게 되면, 상대방 프로세스가 <code>send</code>를 통해 무언가를 보낼때 까지 blocking된다. 따라서, 타이밍을 잘 맞춰서 사용하도록 하자.</p><h3 id="Example-of-Blocking-Communication-in-PyTorch"><a href="#Example-of-Blocking-Communication-in-PyTorch" class="headerlink" title="Example of Blocking Communication in PyTorch"></a>Example of Blocking Communication in PyTorch</h3><p>다음은 init_process_group의 예제에다가 blocking communication을 구현한 예제이다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-comment"># GPU개수는 2개라고 가정하자</span><br>os.environ[<span class="hljs-string">&quot;CUDA_VISIBLE_DEVICES&quot;</span>] = <span class="hljs-string">&quot;0,1&quot;</span><br><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.distributed <span class="hljs-keyword">as</span> dist<br><span class="hljs-keyword">from</span> torch.multiprocessing <span class="hljs-keyword">import</span> Process<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">rank, size</span>):</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">프로세스가 실행하는 메인 함수</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>tensor = torch.FloatTensor([<span class="hljs-number">0.0</span>])<br><span class="hljs-keyword">if</span> rank == <span class="hljs-number">1</span>:<br>tensor += <span class="hljs-number">1</span><br>dist.send(tensor=tensor, dst=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">elif</span> rank == <span class="hljs-number">0</span>:<br>dist.recv(tensor=tensor, src=<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Rank:&quot;</span>, rank, <span class="hljs-string">&quot;, Tensor:&quot;</span>, tensor[<span class="hljs-number">0</span>])<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_process</span>(<span class="hljs-params">rank, size, fn, backend=<span class="hljs-string">&quot;gloo&quot;</span></span>):</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">이 함수는 각 프로세스에서 실행되는 함수이다.</span><br><span class="hljs-string">이 함수는 각 프로세스가 만들어졌을 때, 프로세스 그룹을</span><br><span class="hljs-string">세팅하기 위한 함수로, 세팅이 끝나면, 마지막으로 메인 함수인 run을 호출한다.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;I am a <span class="hljs-subst">&#123;rank&#125;</span> process!&quot;</span>)<br><br><span class="hljs-comment"># 각 프로세스에서는 MASTER_ADDR와 MASTER_PORT 환경변수를 설정해준다.</span><br>os.environ[<span class="hljs-string">&quot;MASTER_ADDR&quot;</span>] = <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>os.environ[<span class="hljs-string">&quot;MASTER_PORT&quot;</span>] = <span class="hljs-string">&quot;24500&quot;</span><br><br><span class="hljs-comment"># 이 프로세스는 127.0.0.1:24500 을 마스터로 하는 프로세스 그룹에 속한다는 것을</span><br><span class="hljs-comment"># 알려준다.</span><br>dist.init_process_group(backend, rank=rank, world_size=size)<br><br><span class="hljs-comment"># fn 함수 호출</span><br>fn(rank, size)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br><span class="hljs-comment"># GPU 개수 얻어오기</span><br>size = torch.cuda.device_count()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Device count:&quot;</span>, size)<br><br>processes = []<br><br><span class="hljs-comment"># GPU개수만큼 프로세스 생성 후 각 프로세스에서 init_process 구동</span><br><span class="hljs-keyword">for</span> rank <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size):<br>p = Process(target=init_process, args=(rank, size, run))<br>p.start()<br>processes.append(p)<br><br><span class="hljs-comment"># 모든 자식이 죽을때까지 기다렸다가 자원 회수</span><br><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:<br>p.join()<br></code></pre></td></tr></table></figure><p>프로세스의 생성과 <code>init_process_group</code>까지는 이전 예제와 같다. 달라진점은 <code>run</code> 함수 내에 다른 peer 프로세스와 통신하는 코드를 넣었다는 점이다.</p><p>말했다시피, 통신은 <code>send</code>함수와 <code>recv</code>함수를 사용한다. send함수는 <code>tensor</code> 객체를 <code>dst</code> 프로세스에게 보내는데, <code>dst</code>에 들어갈 값은 메시지를 받을 프로세스의 rank값이다.</p><p><code>recv</code>함수 역시, 비슷하게 사용하면 되는데, <code>src</code> 프로세스로부터 어떤 텐서를 받아서 <code>tensor</code> 객체에 저장한다. 이때, <code>tensor</code>는 미리 생성해두어야 하며, <code>recv</code>는 받은 텐서객체를 <code>tensor</code>에 덮어씌우게 된다.</p><p>실행결과, 텐서값은 두 프로세스 모두 1이 된다. 0번 프로세스의 경우, 직접 <code>tensor += 1</code>을 해주었고, 1번 프로세스의 경우, 0번으로부터 받은 텐서로 덮어씌웠기 때문이다.</p><h2 id="Non-blocking-Communication-in-PyTorch"><a href="#Non-blocking-Communication-in-PyTorch" class="headerlink" title="Non-blocking Communication in PyTorch"></a>Non-blocking Communication in PyTorch</h2><p>PyTorch에서 process간 통신은 blocking과 non-blocking방식 모두 존재한다고 말했었다. PyTorch는 <code>torch.distributed.send</code>와 <code>torch.distributed.recv</code>라는 blocking 통신을 제공했는데, 이와 비슷하게 <code>torch.distributed.isend</code>, <code>torch.distributed.irecv</code>라는 non-blocking 통신을 제공한다.</p><p><code>torch.distributed.isend</code>를 사용하여 텐서를 그룹 내 어떤 프로세스에게 전송하게 되면, 그 텐서를 수신자가 받을 때까지 기다리지 않고, 바로 리턴되는데, 이때, <code>torch.distributed.isend</code>는 request 객체를 반환한다(<code>torch.distributed.send</code>는 아무것도 반환하지 않음). 메시지가 전달되었는지에 대한 여부는 request 객체의 <code>wait</code> 메소드를 호출하면 알 수 있다. <code>wait</code> 메소드를 호출했을 때, blocking되면 아직 전송이 안된 것이고, 리턴되면 전송된 것이다.</p><p>마찬가지로, <code>torch.distributed.irecv</code>를 호출하게 되면, 텐서가 올때까지 기다리는 게 아니라 request객체를 바로 반환하게 된다(백그라운드에서 송신자로부터 텐서를 계속 기다리고 있음). 텐서가 왔는지 확인하려면 request 객체의 <code>wait</code> 메소드를 호출하면 된다. 역시, blocking되면, 아직 텐서를 못받은 것이고, 리턴되면 텐서를 받은 것이다.</p><h3 id="Example-of-Non-blocking-Communication-in-PyTorch"><a href="#Example-of-Non-blocking-Communication-in-PyTorch" class="headerlink" title="Example of Non-blocking Communication in PyTorch"></a>Example of Non-blocking Communication in PyTorch</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.distributed <span class="hljs-keyword">as</span> dist<br><span class="hljs-keyword">from</span> torch.multiprocessing <span class="hljs-keyword">import</span> Process<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">rank, world_size</span>):</span><br>  <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">  프로세스가 실행하는 메인 함수</span><br><span class="hljs-string">  &#x27;&#x27;&#x27;</span><br>  tensor = torch.FloatTensor([<span class="hljs-number">0.0</span>])<br>  <span class="hljs-keyword">if</span> rank == <span class="hljs-number">0</span>:<br>    tensor += <span class="hljs-number">1</span><br>    req = dist.isend(tensor=tensor, dst=<span class="hljs-number">1</span>)<br>  <span class="hljs-keyword">else</span>:<br>    req = dist.irecv(tensor=tensor, src=<span class="hljs-number">0</span>)<br>  req.wait()<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Rank:&quot;</span>, rank, <span class="hljs-string">&quot;, Tensor:&quot;</span>, tensor[<span class="hljs-number">0</span>])<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_process</span>(<span class="hljs-params">rank, world_size, fn, backend=<span class="hljs-string">&quot;gloo&quot;</span></span>):</span><br>  <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">  이 함수는 각 프로세스에서 실행되는 함수이다.</span><br><span class="hljs-string">  이 함수는 각 프로세스가 만들어졌을 때, 프로세스 그룹을</span><br><span class="hljs-string">  세팅하기 위한 함수로, 세팅이 끝나면, 마지막으로 메인 함수인 run을 호출한다.</span><br><span class="hljs-string">  &#x27;&#x27;&#x27;</span><br><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;I am a <span class="hljs-subst">&#123;rank&#125;</span> process!&quot;</span>)<br><br>  <span class="hljs-comment"># 각 프로세스에서는 MASTER_ADDR와 MASTER_PORT 환경변수를 설정해준다.</span><br>  os.environ[<span class="hljs-string">&quot;MASTER_ADDR&quot;</span>] = <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>  os.environ[<span class="hljs-string">&quot;MASTER_PORT&quot;</span>] = <span class="hljs-string">&quot;24500&quot;</span><br><br>  <span class="hljs-comment"># 이 프로세스는 127.0.0.1:24500 을 마스터로 하는 프로세스 그룹에 속한다는 것을</span><br>  <span class="hljs-comment"># 알려준다.</span><br>  dist.init_process_group(backend, rank=rank, world_size=world_size)<br><br>  <span class="hljs-comment"># fn 함수 호출</span><br>  fn(rank, world_size)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>  <span class="hljs-comment"># GPU 개수 얻어오기</span><br>  world_size = torch.cuda.device_count()<br><br>  processes = []<br><br>  <span class="hljs-comment"># GPU개수만큼 프로세스 생성 후 각 프로세스에서 init_process 구동</span><br>  <span class="hljs-keyword">for</span> rank <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(world_size):<br>    p = Process(target=init_process, args=(rank, world_size, run))<br>    p.start()<br>    processes.append(p)<br><br>  <span class="hljs-comment"># 모든 자식이 죽을때까지 기다렸다가 자원 회수</span><br>  <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:<br>    p.join()<br></code></pre></td></tr></table></figure><h2 id="Reduce-amp-Broadcast"><a href="#Reduce-amp-Broadcast" class="headerlink" title="Reduce &amp; Broadcast"></a>Reduce &amp; Broadcast</h2><p><code>dist.recv</code>, <code>dist.send</code>, <code>dist.irecv</code>, <code>dist.isend</code> 처럼 텐서 단위를 직접 주고받는 연산도 있지만, 각 프로세스에 있는 텐서를 자동으로 모아서 합쳐준다거나, 하나의 텐서를 모든 프로세스에게 자동으로 뿌려주는 연산도 있다. 전자는 <code>reduce</code>, 후자는 <code>broadcast</code>로써 PyTorch에서 함수로 지원한다.</p><h3 id="Reduce"><a href="#Reduce" class="headerlink" title="Reduce"></a>Reduce</h3><p>Reduce는 각 프로세스에 있는 텐서를 모아서 aggregation해주는 함수로, <code>dist.reduce</code>로 존재한다. 다음 예시 코드를 보자.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch.utils.data.distributed <span class="hljs-keyword">import</span> DistributedSampler<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> distributed <span class="hljs-keyword">as</span> dist<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> multiprocessing <span class="hljs-keyword">as</span> mp<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> os<br><br>WORLD_SIZE = <span class="hljs-number">4</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup</span>(<span class="hljs-params">rank, world_size</span>):</span><br>    os.environ[<span class="hljs-string">&quot;MASTER_ADDR&quot;</span>] = <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>    os.environ[<span class="hljs-string">&quot;MASTER_PORT&quot;</span>] = <span class="hljs-string">&quot;25555&quot;</span><br>    os.environ[<span class="hljs-string">&quot;RANK&quot;</span>] = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;rank&#125;</span>&quot;</span><br>    os.environ[<span class="hljs-string">&quot;WORLD_SIZE&quot;</span>] = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;world_size&#125;</span>&quot;</span><br>    <br>    dist.init_process_group(<span class="hljs-string">&quot;gloo&quot;</span>, rank=rank, world_size=world_size)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">rank, world_size</span>):</span><br>    setup(rank, world_size)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        tensor = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># 4개의 머신에서 tensor를 모두 0번 머신으로 보내고,</span><br><span class="hljs-comment"># 0번 머신은 tensor를 모두 모아서 SUM한 값을 tensor에 대입한다.</span><br>        dist.reduce(tensor, <span class="hljs-number">0</span>, dist.ReduceOp.SUM)<br>        <span class="hljs-built_in">print</span>(tensor)<br><br>        time.sleep(<span class="hljs-number">1</span>)<br>        <br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>mp.spawn(run, args=(WORLD_SIZE,), nprocs=WORLD_SIZE, join=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>이 코드는 1초마다 4개의 프로세스에서 (2, 2) 크기의 랜덤 텐서를 생성하고 텐서를 0번 텐서에 모두 모아서 덧셈하는 것을 수행하는 코드이다.</p><p>각 머신이 <code>dist.reduce(tensor, 0, dist.ReduceOp.SUM)</code>라는 코드를 만났을 때 취하는 행동은 다음과 같다.</p><ul><li><p>자신이 0번 프로세스인 경우</p><p>  다른 프로세스로부터 값을 모으고 모두 SUM해서 <code>tensor</code>에 저장한다.</p></li><li><p>자신이 0번 프로세스가 아닌 경우</p><p>  0번 프로세스에게 <code>tensor</code>값을 전송한다.</p></li></ul><p>위 코드에서, 0번 머신은 <code>tensor</code>값이 변하지만, 나머지 프로세스는 <code>tensor</code>값이 변하지 않는다. 0번 머신은 다른 머신이 보낸 텐서를 모두 모아서 더하고 그 값을 <code>tensor</code>로 저장했지만, 나머지 머신은 그저 0번 머신에게 전송만 했기 때문이다.</p><h3 id="Broadcast"><a href="#Broadcast" class="headerlink" title="Broadcast"></a>Broadcast</h3><p>Broadcast는 PyTorch에서 <code>dist.boardcast</code>로 제공되는 기능으로, 하나의 프로세스에서 다른 프로세스로 텐서를 뿌려주는(전파시키는) 역할을 하는 함수이다. 다음 예제를 보자.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> distributed <span class="hljs-keyword">as</span> dist<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">average_gradient</span>(<span class="hljs-params">model, world_size</span>):</span><br><span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> model.parameters():<br><span class="hljs-comment"># gradient를 0번 머신이 모아서 평균냄</span><br>dist.reduce(param.grad.data, <span class="hljs-number">0</span>, dist.ReduceOp.SUM)<br>param.grad.data /= world_size<br><br><span class="hljs-comment"># 0번 머신은 gradient를 모두에게 전송함</span><br>dist.broadcast(param.grad.data, <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p>이 예제에서, <code>dist.broadcast</code>는 0번 머신이 자신의 데이터(gradient)를 모든 머신에게 전송하는 역할을 한다.</p><p>각 프로세스가 <code>dist.broadcast(tensor, 0)</code>라는 코드를 만났을때, 수행하는 행동은 다음과 같다.</p><ul><li><p>자신이 0번 프로세스인 경우</p><p>  자신의 <code>tensor</code>데이터를 모두에게 전송한다.</p></li><li><p>자신이 0번 프로세스가 아닌 경우,</p><p>  0번 프로세스로부터 데이터를 받을때까지 기다리고, 데이터를 받으면 <code>tensor</code>에 저장한다.</p></li></ul><h2 id="Machine-to-Machine-Communication"><a href="#Machine-to-Machine-Communication" class="headerlink" title="Machine-to-Machine Communication"></a>Machine-to-Machine Communication</h2><p>PyTorch 통신은 프로세스끼리도 가능하지만 다른 컴퓨터끼리도 가능하다. 해답은 <code>MASTER_ADDR</code>를 다른 컴퓨터 IP 주소로 설정하는 것이다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup</span>(<span class="hljs-params">rank, world_size</span>):</span><br>    os.environ[<span class="hljs-string">&quot;MASTER_ADDR&quot;</span>] = <span class="hljs-string">&quot;???.???.???.???&quot;</span><br>    os.environ[<span class="hljs-string">&quot;MASTER_PORT&quot;</span>] = <span class="hljs-string">&quot;25555&quot;</span><br>    os.environ[<span class="hljs-string">&quot;RANK&quot;</span>] = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;rank&#125;</span>&quot;</span><br>    os.environ[<span class="hljs-string">&quot;WORLD_SIZE&quot;</span>] = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;world_size&#125;</span>&quot;</span><br>    <br>    dist.init_process_group(<span class="hljs-string">&quot;nccl&quot;</span>, rank=rank, world_size=world_size)<br></code></pre></td></tr></table></figure><p>MASTER_ADDR에 들어가는 주소는 다른 컴퓨터가 인지 가능한 주소여야 하며, <strong>마스터 자신또한 자신이 해당 주소라는 것을 알 수 있어야 한다.</strong></p><p>“마스터 자신또한 자신이 해당 주소라는 것을 알 수 있어야 한다”는 점도 상당히 중요한데, 만약, GCP(Google Cloud Platform)와 같은 서비스를 이용해서 분산 처리 시스템을 구현한다면, 이게 문제가 될 수 있다.</p><p>만약, GCP의 같은 계정, 같은 region 안에 존재하는 서버끼리는(또는 같은 VPC 네트워크 내에 존재하는 서버끼리는) 문제없이 통신되지만, 다른 GCP 계정에 존재하는 서버와 PyTorch 통신을 하려는 경우, 이게 문제가 생긴다.</p><p><code>dist.init_process_group</code>에서는 외부 IP로 연결이 가능하지만, 그 이후에 각 머신이 서로 통신하는 과정은 각 머신이 알고 있는 자신의 IP로 통신을 시도한다. 근데, GCP VM은 자신의 외부 IP를 모른다(ifconfig 입력해보면 자신의 외부 IP가 나오지 않음). 이것 때문에, <code>dist.init_proces_group</code>은 통과하지만, 그 이후 통신에서 connect가 안되는 문제가 발생할 수 있다.</p><p>만약, 본인 계정에서 머신 여러개를 만들고 통신하는건 문제가 되지 않는다. 하지만, 다른 VPC 네트워크에 존재하는 VM으로의 통신은 필자가 알기로는 방법이 없어 보인다. 따라서, 다른 VPC 네트워크에 속한 VM과 통신하고자 한다면, PyTorch 통신 이외에 다른 통신법을 찾아보기를 권한다.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Distributed-Programming-in-PyTorch&quot;&gt;&lt;a href=&quot;#Distributed-Programming-in-PyTorch&quot; class=&quot;headerlink&quot; title=&quot;Distributed Programming 
      
    
    </summary>
    
      <category term="프로그래밍" scheme="https://the-masked-developer.github.io/categories/%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/"/>
    
    
      <category term="프로그래밍" scheme="https://the-masked-developer.github.io/tags/%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/"/>
    
  </entry>
  
  <entry>
    <title>Helm 사용해보기</title>
    <link href="https://the-masked-developer.github.io/wiki/helm/"/>
    <id>https://the-masked-developer.github.io/wiki/helm/</id>
    <published>2021-11-20T14:15:22.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Helm-사용해보기"><a href="#Helm-사용해보기" class="headerlink" title="Helm 사용해보기"></a>Helm 사용해보기</h2><span id="more"></span><iframe src="/presentation/helm"></iframe><h2 id="1-Helm이란"><a href="#1-Helm이란" class="headerlink" title="1. Helm이란."></a>1. Helm이란.</h2><p><img src="https://user-images.githubusercontent.com/26294469/142736328-9e42a5b0-f279-43d7-8957-e2c3567c12ff.png" alt="w:800 center"></p><blockquote><p>비유를 한다면 개발자가 Docker Registry에서 검색하여 쉽게 이미 셋팅된 컨테이너 환경을 실행하듯이<br>Helm에서 검색하여 이미 셋팅된 쿠버네티스 환경을 실행한다라고 이해하면 되지 않을 듯 싶다.<br>ex. <code>Dockerhub</code>처럼 <code>ArtifactHub</code>에서 많은 템플릿이 등록되고 공유되고 있다.</p></blockquote><p>컨테이너 환경을 <code>Dockerfile</code>로 구성 하는 것처럼 Helm도 <code>차트</code>로 구성을 한다.</p><ul><li><code>차트</code> = 쿠버네티스 YAML을 템플릿으로 구성한 파일들</li></ul><p><img src="https://user-images.githubusercontent.com/26294469/142736520-489f1f42-d87c-4526-acc1-62a8db760aab.png" alt=""></p><h2 id="2-Usage-Helm-Chart-생성"><a href="#2-Usage-Helm-Chart-생성" class="headerlink" title="2. Usage. Helm Chart 생성"></a>2. Usage. Helm Chart 생성</h2><ul><li><p>Helm Chart를 생성하기 위해서는 위에서 설명한 구조의 파일들을 생성할 필요가 있음</p></li><li><p>nginx 템플릿을 단계별로 구성하여 따라해보기</p></li></ul><h3 id="2-1-templates-폴더-생성하여-배포할-쿠버네티스-YAML-작성"><a href="#2-1-templates-폴더-생성하여-배포할-쿠버네티스-YAML-작성" class="headerlink" title="2-1. /templates 폴더 생성하여 배포할 쿠버네티스 YAML 작성"></a>2-1. <code>/templates</code> 폴더 생성하여 배포할 쿠버네티스 YAML 작성</h3><blockquote><p>deployment, service YAML은 뒤에 작성</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>└── templates<br>    ├── deployment.yaml<br>    └── service.yaml<br></code></pre></td></tr></table></figure><h4 id="deployment-yaml"><a href="#deployment-yaml" class="headerlink" title="deployment.yaml"></a><code>deployment.yaml</code></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-test</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-test</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-test</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-test</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><h4 id="service-yaml"><a href="#service-yaml" class="headerlink" title="service.yaml"></a><code>service.yaml</code></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-test</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-test</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br></code></pre></td></tr></table></figure><h3 id="2-2-Chart-yaml-작성"><a href="#2-2-Chart-yaml-작성" class="headerlink" title="2-2. Chart.yaml 작성"></a>2-2. <code>Chart.yaml</code> 작성</h3><ul><li><code>Chart.yaml</code> = Helm 차트의 이름, 버전 등 메타데이터를 입력하는 파일</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v2</span> <span class="hljs-comment"># 차트 API 버전 (필수)</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">nginx-test</span> <span class="hljs-comment"># 차트명 (필수)</span><br><span class="hljs-attr">version:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.1</span> <span class="hljs-comment"># SemVer 2 버전 (필수)</span><br></code></pre></td></tr></table></figure><p>현재 파일 구성</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>├── Chart.yaml<br>└── templates<br>    ├── deployment.yaml<br>    └── service.yaml<br></code></pre></td></tr></table></figure><h3 id="2-3-values-yaml-작성"><a href="#2-3-values-yaml-작성" class="headerlink" title="2-3. values.yaml 작성"></a>2-3. <code>values.yaml</code> 작성</h3><ul><li><code>values.yaml</code> = <code>/templates</code> 내부에 쿠버네티스 YAML에 있는 값을 동적으로 지정할 때 사용하는 파일</li><li>일단은 파일이 비어있는 상태로도 설치가 가능하기 때문에 파일만 생성</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">touch values.yaml<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>├── Chart.yaml<br>├── templates<br>│   ├── deployment.yaml<br>│   └── service.yaml<br>└── values.yaml<br></code></pre></td></tr></table></figure><h3 id="2-4-Helm-Chart-설치"><a href="#2-4-Helm-Chart-설치" class="headerlink" title="2-4. Helm Chart 설치"></a>2-4. Helm Chart 설치</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm install &lt;이름&gt; &lt;차트_경로&gt; -n &lt;네임스페이스&gt;<br></code></pre></td></tr></table></figure><p>실행 결과</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># helm install nginx-test . -n test</span><br><br>NAME: nginx-test<br>LAST DEPLOYED: Sun Nov 21 05:41:08 2021<br>NAMESPACE: <span class="hljs-built_in">test</span><br>STATUS: deployed<br>REVISION: 1 <span class="hljs-comment"># helm upgrade 반영 횟수</span><br>TEST SUITE: None<br></code></pre></td></tr></table></figure><p>Helm 조회</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># helm ls -n test</span><br>NAME      NAMESPACEREVISIONUPDATED                                STATUS  CHART           APP VERSION<br>nginx-test<span class="hljs-built_in">test</span>     1       2021-11-21 05:41:08.564944731 +0900 KSTdeployednginx-test-0.0.1<br></code></pre></td></tr></table></figure><h3 id="2-5-실제-쿠버네티스-배포현황-확인"><a href="#2-5-실제-쿠버네티스-배포현황-확인" class="headerlink" title="2-5. 실제 쿠버네티스 배포현황 확인"></a>2-5. 실제 쿠버네티스 배포현황 확인</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># k get deploy,svc -n test</span><br>NAME                         READY   UP-TO-DATE   AVAILABLE   AGE<br>deployment.apps/nginx-test   1/1     1            1           4m3s<br><br>NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE<br>service/nginx-test   ClusterIP   10.100.29.142   &lt;none&gt;        80/TCP    4m3s<br></code></pre></td></tr></table></figure><h2 id="3-Usage-Helm-Chart-삭제"><a href="#3-Usage-Helm-Chart-삭제" class="headerlink" title="3. Usage. Helm Chart 삭제"></a>3. Usage. Helm Chart 삭제</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm delete &lt;릴리즈된_차트명&gt; -n &lt;네임스페이스&gt;<br></code></pre></td></tr></table></figure><p>실행 결과</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># helm delete nginx-test -n test</span><br><br>release <span class="hljs-string">&quot;nginx-test&quot;</span> uninstalled<br></code></pre></td></tr></table></figure><p>이후, <code>helm ls -n test</code> 명령어 실행시 차트가 삭제된 것을 확인할 수 있음</p><h2 id="4-Usage-values-yaml으로-템플릿-문법-사용"><a href="#4-Usage-values-yaml으로-템플릿-문법-사용" class="headerlink" title="4. Usage. values.yaml으로 템플릿 문법 사용"></a>4. Usage. values.yaml으로 템플릿 문법 사용</h2><blockquote><p>“values.yaml = /templates 내부에 쿠버네티스 YAML에 있는 값을 동적으로 지정할 때 사용하는 파일” 라고 이야기된 단계에 관한 설명</p></blockquote><ul><li>위 과정을 하기 위해서는 <a href="https://helm.sh/ko/docs/chart_template_guide/values_files/">템플릿 문법</a>을 사용해야함</li><li>예시로 <code>/templates</code> 내에 <code>deployment.yaml</code>에서 이미지 버전이 현재 <code>latest</code>로 되어있는 것을 외부에서 바꿀 수 있게 변경을 진행</li></ul><h3 id="4-1-templates-yaml-수정"><a href="#4-1-templates-yaml-수정" class="headerlink" title="4-1. /templates/*.yaml 수정"></a>4-1. <code>/templates/*.yaml</code> 수정</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">...</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:&#123;&#123;</span> <span class="hljs-string">.Values.version</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><h3 id="4-2-values-yaml-수정"><a href="#4-2-values-yaml-수정" class="headerlink" title="4-2. values.yaml 수정"></a>4-2. <code>values.yaml</code> 수정</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">stable</span><br></code></pre></td></tr></table></figure><h3 id="3-Helm-Chart-설치"><a href="#3-Helm-Chart-설치" class="headerlink" title="3. Helm Chart 설치"></a>3. Helm Chart 설치</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm install nginx-values-test .<br></code></pre></td></tr></table></figure><p>실행 결과</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">NAME: nginx-values-test<br>LAST DEPLOYED: Sun Nov 21 06:11:26 2021<br>NAMESPACE: <span class="hljs-built_in">test</span><br>STATUS: deployed<br>REVISION: 1<br>TEST SUITE: None<br></code></pre></td></tr></table></figure><p>배포 확인: 아래처럼 image version tag가 바뀐 것을 확인할 수 있다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">k get deploy nginx-test -o yaml<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">...<br>      - image: nginx:stable<br></code></pre></td></tr></table></figure><h3 id="Helm-Chart로-공개된-오픈소스-문법-참고"><a href="#Helm-Chart로-공개된-오픈소스-문법-참고" class="headerlink" title="Helm Chart로 공개된 오픈소스 문법 참고"></a>Helm Chart로 공개된 오픈소스 문법 참고</h3><ul><li><a href="https://artifacthub.io/packages/helm/bitnami/nginx">Nginx</a></li><li><a href="https://artifacthub.io/packages/helm/prometheus-community/prometheus">Prometheus</a></li><li><a href="https://artifacthub.io/packages/helm/grafana/grafana">Grafana</a></li></ul><h2 id="5-Usage-Release-템플릿-문법-사용"><a href="#5-Usage-Release-템플릿-문법-사용" class="headerlink" title="5. Usage. Release 템플릿 문법 사용"></a>5. Usage. Release 템플릿 문법 사용</h2><p>기존 <code>.Values</code> 템플릿 문법으로는 <code>helm install &lt;차트명&gt;</code>에서 입력되는 <code>차트명</code>까지는 가져오지 못한다.<br>이러한 문제를 해결해주기 위한 템플릿 문법으로 <code>.Release</code>가 있다.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 1. /templates/deployment.yaml 릴리즈 템플릿 적용</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> &#123;&#123; <span class="hljs-string">.Release.Name</span> &#125;&#125;<br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> &#123;&#123; <span class="hljs-string">.Release.Name</span> &#125;&#125;<br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> &#123;&#123; <span class="hljs-string">.Release.Name</span> &#125;&#125;<br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> &#123;&#123; <span class="hljs-string">.Release.Name</span> &#125;&#125;<br><span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 2. /templates/service.yaml 릴리즈 템플릿 적용</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> &#123;&#123; <span class="hljs-string">.Release.Name</span> &#125;&#125;<br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> &#123;&#123; <span class="hljs-string">.Release.Name</span> &#125;&#125;<br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br></code></pre></td></tr></table></figure><p>Helm Chart 설치 (<code>.Release</code> 문법 적용)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm install nginx-rename-test . -n <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure><p>실행 결과</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># helm install nginx-rename-test . -n test</span><br>NAME: nginx-rename-test<br>LAST DEPLOYED: Sun Nov 21 06:48:04 2021<br>NAMESPACE: <span class="hljs-built_in">test</span><br>STATUS: deployed<br>REVISION: 1<br>TEST SUITE: None<br><span class="hljs-comment"># helm ls -n test</span><br>NAME             NAMESPACEREVISIONUPDATED                                STATUS  CHART           APP VERSION<br>nginx-rename-test<span class="hljs-built_in">test</span>     1       2021-11-21 06:48:04.719317331 +0900 KSTdeployednginx-test-0.0.1           <br>nginx-values-test<span class="hljs-built_in">test</span>     1       2021-11-21 06:11:26.928779655 +0900 KSTdeployednginx-test-0.0.1<br></code></pre></td></tr></table></figure><blockquote><p>아래 명령을 실행하면, Helm이 최종적으로 어떤 정보로 릴리즈를 했는지 알 수 있다.</p></blockquote><p>Helm 명명된 릴리스에 대한 모든 정보 조회</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm get all &lt;RELEASE_NAME&gt;<br></code></pre></td></tr></table></figure><p>실행 결과</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># helm get all nginx-rename-test</span><br>NAME: nginx-rename-test<br>LAST DEPLOYED: Sun Nov 21 06:48:04 2021<br>NAMESPACE: <span class="hljs-built_in">test</span><br>STATUS: deployed<br>REVISION: 1<br>TEST SUITE: None<br>USER-SUPPLIED VALUES:<br>null<br><br>COMPUTED VALUES:<br>version: stable<br><br>HOOKS:<br>MANIFEST:<br>---<br><span class="hljs-comment"># Source: nginx-test/templates/service.yaml</span><br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: nginx-rename-test<br>spec:<br>  selector:<br>    app: nginx-rename-test<br>  ports:<br>  - port: 80<br>    targetPort: 80<br>  <span class="hljs-built_in">type</span>: ClusterIP<br>---<br><span class="hljs-comment"># Source: nginx-test/templates/deployment.yaml</span><br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nginx-rename-test<br>  labels:<br>    app: nginx-rename-test<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: nginx-rename-test<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx-rename-test<br>    spec:<br>      containers:<br>      - name: nginx<br>        image: nginx:stable<br>        ports:<br>        - containerPort: 80<br></code></pre></td></tr></table></figure><h2 id="6-Usage-그-외-Helm-자주-사용하는-명령어"><a href="#6-Usage-그-외-Helm-자주-사용하는-명령어" class="headerlink" title="6. Usage. 그 외 Helm 자주 사용하는 명령어"></a>6. Usage. 그 외 Helm 자주 사용하는 명령어</h2><ul><li><p>릴리스 히스토리를 가져오기, 업그레이드 내역(revision) 확인 등 유용</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm <span class="hljs-built_in">history</span> &lt;릴리즈_차트명&gt;<br></code></pre></td></tr></table></figure></li><li><p>Helm Chart 문법 검사</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm lint &lt;차트_경로&gt;<br></code></pre></td></tr></table></figure></li><li><p>Helm <code>/templates</code> + <code>values.yaml</code> 최종 결과를 보여준다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm template &lt;차트명&gt; &lt;차트_경로&gt;<br></code></pre></td></tr></table></figure></li><li><p>Helm 차트 릴리즈 업그레이드</p><blockquote><p>추후 과정에서 더 자세히 설명</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm upgrade &lt;릴리즈_차트명&gt; &lt;차트_경로&gt;<br></code></pre></td></tr></table></figure></li></ul><h2 id="7-Usage-values-yaml-override"><a href="#7-Usage-values-yaml-override" class="headerlink" title="7. Usage. values.yaml override"></a>7. Usage. values.yaml override</h2><ul><li>보통의 경우에는 <code>values.yaml</code>을 직접 작성하지 않고, 남이 작성한 파일을 가져오기 때문에 override(덮어쓰기)하여 사용이 된다. </li><li>아래의 2가지 방법이 있다.<ul><li><code>--set</code> 인자 사용</li><li><code>-f</code> 옵션으로 파일을 작성</li></ul></li></ul><h3 id="1-set-인자-사용"><a href="#1-set-인자-사용" class="headerlink" title="1. --set 인자 사용"></a>1. <code>--set</code> 인자 사용</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm install --<span class="hljs-built_in">set</span> version=1.21.4 -n <span class="hljs-built_in">test</span> nginx-set-test .<br></code></pre></td></tr></table></figure><p>실행 결과</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">NAME: nginx-set-test<br>LAST DEPLOYED: Sun Nov 21 07:09:41 2021<br>NAMESPACE: <span class="hljs-built_in">test</span><br>STATUS: deployed<br>REVISION: 1<br>TEST SUITE: None<br></code></pre></td></tr></table></figure><p>배포 결과 (<code>values.yaml</code> <code>version</code> 값이 <code>stable</code>이지만 1.21.4로 된 것을 알 수 있음)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># k get deploy -n test nginx-set-test -o yaml | grep image</span><br>...<br>      - image: nginx:1.21.4<br></code></pre></td></tr></table></figure><h3 id="2-f-옵션으로-파일을-작성"><a href="#2-f-옵션으로-파일을-작성" class="headerlink" title="2. -f 옵션으로 파일을 작성"></a>2. <code>-f</code> 옵션으로 파일을 작성</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm install -f &lt;파일경로&gt; -n <span class="hljs-built_in">test</span> nginx-file-test .<br></code></pre></td></tr></table></figure><h4 id="2-1-override-values-yaml-파일을-아래와-같이-작성"><a href="#2-1-override-values-yaml-파일을-아래와-같이-작성" class="headerlink" title="2-1. override_values.yaml 파일을 아래와 같이 작성"></a>2-1. <code>override_values.yaml</code> 파일을 아래와 같이 작성</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">version: stable-alpine<br></code></pre></td></tr></table></figure><p>차트 파일 구성</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>├── Chart.yaml<br>├── override_values.yaml <span class="hljs-comment"># 추가됨</span><br>├── templates<br>│   ├── deployment.yaml<br>│   └── service.yaml<br>└── values.yaml<br><br>1 directory, 5 files<br></code></pre></td></tr></table></figure><h4 id="2-2-f-옵션으로-Helm-Chart-설치"><a href="#2-2-f-옵션으로-Helm-Chart-설치" class="headerlink" title="2-2. -f 옵션으로 Helm Chart 설치"></a>2-2. <code>-f</code> 옵션으로 Helm Chart 설치</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm install -f override_values.yaml -n <span class="hljs-built_in">test</span> nginx-file-test .<br></code></pre></td></tr></table></figure><p>실행 결과</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">NAME: nginx-file-test<br>LAST DEPLOYED: Sun Nov 21 07:16:31 2021<br>NAMESPACE: <span class="hljs-built_in">test</span><br>STATUS: deployed<br>REVISION: 1<br>TEST SUITE: None<br></code></pre></td></tr></table></figure><p>배포 결과</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># k get deploy -n test nginx-file-test -o yaml | grep image</span><br>...<br>      - image: nginx:stable-alpine<br></code></pre></td></tr></table></figure><ul><li>실제 override 할 때는 각 차트의 <code>configuration</code> 항목을 참조하여 변경 필요한 값만 지정하여 설치</li><li>예제. <a href="https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-helm/#configuration">nginx chart</a></li></ul><p><img src="https://user-images.githubusercontent.com/26294469/142742446-d6feb539-e6fe-4e97-84ef-552482248ca6.png" alt=""></p><h2 id="8-Usage-Helm-Chart-업그레이드"><a href="#8-Usage-Helm-Chart-업그레이드" class="headerlink" title="8. Usage. Helm Chart 업그레이드"></a>8. Usage. Helm Chart 업그레이드</h2><ul><li>기존 릴리즈된 차트 내용을 변경 요구시 사용</li><li>이력 관리를 위해 사용</li></ul><h3 id="1-Helm-Chart-기본-설치"><a href="#1-Helm-Chart-기본-설치" class="headerlink" title="1. Helm Chart 기본 설치"></a>1. Helm Chart 기본 설치</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm install -n <span class="hljs-built_in">test</span> nginx-test .<br></code></pre></td></tr></table></figure><ul><li>결과 확인 (revision)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm get all nginx-test<br></code></pre></td></tr></table></figure></li></ul><p><img src="https://user-images.githubusercontent.com/26294469/142742623-62f7f6c4-d87b-46bb-b899-7232f44814cf.png" alt=""></p><h3 id="2-Helm-Chart-업그레이드"><a href="#2-Helm-Chart-업그레이드" class="headerlink" title="2. Helm Chart 업그레이드"></a>2. Helm Chart 업그레이드</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm upgrade --<span class="hljs-built_in">set</span> version=stable-alpine -n <span class="hljs-built_in">test</span> nginx-test .<br></code></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/26294469/142742713-afdd2673-2daa-4252-aaa7-8c515c93b82f.png" alt="image"></p><ul><li><code>REVISION</code>이 올라가고 이미지 배포 버전이 바뀐 것을 알 수 있음</li><li><code>values.yaml</code>을 변경하고 업그레이드를 진행하여도 변경이 됨</li></ul><h3 id="업그레이드시-주의사항"><a href="#업그레이드시-주의사항" class="headerlink" title="업그레이드시 주의사항"></a>업그레이드시 주의사항</h3><ul><li>Helm 업그레이드시 Pod가 재기동됨(RollingUpdate)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1</span><br>helm upgrade --<span class="hljs-built_in">set</span> version=stable-alpine -n <span class="hljs-built_in">test</span> nginx-test .<br><br><span class="hljs-comment"># 2</span><br>helm upgrade -n <span class="hljs-built_in">test</span> nginx-test .<br></code></pre></td></tr></table></figure><p>위 과정을 진행하면, helm 버전에 따라 <code>values.yaml</code>참고가 다르다.</p><ul><li>version3: 이전 <code>revision</code>을 그대로 따라 버전을 유지</li><li>version2: 이전 <code>revision</code> 버전을 유지하지 않는다. (첫 설치 <code>values.yaml</code>)</li></ul><h2 id="9-Helm-Rollback"><a href="#9-Helm-Rollback" class="headerlink" title="9. Helm Rollback"></a>9. Helm Rollback</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm rollback &lt;릴리즈_차트명&gt; &lt;REVISION&gt;<br></code></pre></td></tr></table></figure><p>실행 결과</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@acc-master nginx-chart]<span class="hljs-comment"># helm rollback -n test nginx-test 1</span><br>Rollback was a success! Happy Helming!<br>[root@acc-master nginx-chart]<span class="hljs-comment"># helm ls</span><br>NAME      NAMESPACEREVISIONUPDATED                                STATUS  CHART           APP VERSION<br>nginx-test<span class="hljs-built_in">test</span>     3       2021-11-21 07:47:41.211560477 +0900 KSTdeployednginx-test-0.0.1           <br>[root@acc-master nginx-chart]<span class="hljs-comment"># k get deploy -n test nginx-test -o yaml | grep image</span><br>                f:image: &#123;&#125;<br>                f:imagePullPolicy: &#123;&#125;<br>      - image: nginx:stable<br>        imagePullPolicy: IfNotPresent<br></code></pre></td></tr></table></figure><ul><li>롤백은 한다고 해도 <code>revision</code>은 이력관리를 위해 증가한다.</li><li>버전이 최초 설치와 동일한 <code>stable</code>로 변경된 것을 알 수 있다.</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Helm-사용해보기&quot;&gt;&lt;a href=&quot;#Helm-사용해보기&quot; class=&quot;headerlink&quot; title=&quot;Helm 사용해보기&quot;&gt;&lt;/a&gt;Helm 사용해보기&lt;/h2&gt;
    
    </summary>
    
      <category term="Kubernetes" scheme="https://the-masked-developer.github.io/categories/Kubernetes/"/>
    
      <category term="Helm" scheme="https://the-masked-developer.github.io/categories/Kubernetes/Helm/"/>
    
    
      <category term="Helm" scheme="https://the-masked-developer.github.io/tags/Helm/"/>
    
      <category term="Kubernetes" scheme="https://the-masked-developer.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Bayesian Statistics 01. Probability</title>
    <link href="https://the-masked-developer.github.io/wiki/bayesian-01-probability/"/>
    <id>https://the-masked-developer.github.io/wiki/bayesian-01-probability/</id>
    <published>2021-11-16T14:04:10.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h1 id="01-Probability"><a href="#01-Probability" class="headerlink" title="01. Probability"></a>01. Probability</h1><p>우리는 세상을 살아가는 데 있어서, 무수히 많은 결정(decision)을 내리게 된다. 결정을 내릴 때, 우리는 해당 결정에 영향을 미친 원인들과 해당 결정을 내림으로써 미치는 결과 요인들을 고려하면서 결정을 내리게 된다. 하지만, 많은 요인들을 고려하면서 내린 결정이 잘못된 결정이 되는 경우도 많이 있는데, 이는 결정을 내릴 때 고려하는 요인들을 우리가 완벽히 알지 못하기 때문이다.</p><p>만약, 우리가 세상에 대해 100% 알고, 모든 인과관계를 파악할 수 있다면, 항상 옳은 결정을 내릴 수 있다. 하지만, 세상에는 우리가 알지 못하는 요인들이 무수히 많기 때문에, 우리는 최대한 많은 요인들을 살아오면서 습득한 경험과 지식으로 예측하고 판단하며 최종 결정을 내린다. 다시 말하지만, 이것은 우리가 세상에 존재하는 요인들을 완벽하게는 알지 못하기 때문이다.</p><p><strong>불확실성</strong>이란, 어떤 요인에 대해 완전히 알지 못하기 때문에 발생하는 것으로, 해당 요인에 대해 미리 알고 있는 사전지식과 경험으로 판단하게 된다. 우리가 어떤 결정을 내릴 때, 우리는 결정에 영향을 미치거나 받는 모든 요인들의 불확실성을 고려하게 된다. 하지만, 이러한 불확실성을 모두 고려하기엔 인간의 능력은 한계가 있다.</p><p><strong>확률</strong>은 불확실성을 수치화(정량화)함으로써, 불확실성을 수학으로 다룰 수 있도록 도와주는 도구이다. 확률을 이용하면 불확실성이라는 것을 정량화할 수 있고, 여러가지 수학 도구를 이용해서 불확실성을 모델링할 수 있다. 이러한 수학적 확률 모델은 여러가지 요인들에 대한 불확실성 속에서 우리가 최적의 결정을 내릴 수 있게 도와주는 도구이다.</p><h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>확률을 살펴보기에 앞서서, 필요한 용어들을 먼저 정리할 필요가 있다. 용어들의 정의를 살펴볼때, <strong>집합</strong>이라는 개념을 유의하면서 살펴보면 좋다.</p><ul><li><p><strong>Experiments</strong></p><p>  시행이라고도 불리며, sample space로부터 하나의 데이터 샘플을 얻는 행위를 말한다.</p></li><li><p><strong>Sample space</strong></p><p>  Sample space란, 어떤 시행에 의해 나올 수 있는 모든 경우의 <strong>집합</strong>을 의미한다. 예를들어, 동전던지기라는 시행에서는 뒷면 또는 앞면만이 나올 수 있다. 이때, 동전던지기라는 experiment의 sample space는 ${\text{HEAD}, \text{TAIL}}$이 된다. 주사위를 던지는 experiment에 대해서의 sample space는 ${1, 2, 3, 4, 5, 6}$이 될 것이다.</p></li><li><p><strong>Events</strong></p><p>  사건이라고도 불리며, <strong>sample space의 부분집합</strong>이다. 예를 들어, 주사위를 던지는 시행에서, sample space는 ${1, 2, 3, 4, 5, 6}$이다. 그리고, 다음과 같은 event $A$를 정의할 수 있다.</p><ul><li><p>$A$: 짝수가 나오는 경우</p><p>이때, $A$는 sample space의 부분집합인 ${2, 4, 6}$이 된다.</p></li></ul></li><li><p><strong>Random variables</strong></p><p>  확률변수라고도 불리며, <strong>어떤 experiment를 통해 얻을 수 있는 outcome을 어떤 다른 라벨로 매핑하는 함수</strong>를 의미한다. 예를들어, 주사위를 던지는 experiment가 있다고 가정해보자. 이때, sample space는 ${1, 2, 3, 4, 5, 6}$이 된다.</p><p>  이때, 우리는 random variable $X$를 다음과 같이 정의할 수 있다.</p><ul><li><p>$X = x_1$: 주사위가 짝수인 경우</p></li><li><p>$X=x_2$: 주사위가 홀수인 경우</p></li><li><p>$X=x_3$: 주사위가 4보다 크거나 같은 경우</p><p>Random variable $X$은 여러개의 이벤트중 하나의 이벤트를 취할 수 있으며, 주사위 던지기라는 experiment를 통해 얻을 수 있는 outcome들을 $x_1, x_2, x_3$ 중 하나로 매핑하게 된다. 이때, 이random variable $X$의 sample space는 ${x_1, x_2, x_3}$이 된다. 만약, 주사위를 던지는 시행을 통해 sample 4를 얻었다면, event $x_1$와 $x_3$가 동시에 일어난 것이다.</p></li></ul></li></ul><h1 id="Definition-of-Probability"><a href="#Definition-of-Probability" class="headerlink" title="Definition of Probability"></a>Definition of Probability</h1><p><strong>확률은 불확실성을 정량화하는 도구로, 불확실성을 수학으로 계산할 수 있게 하는 도구이다.</strong></p><p>어떤 experiment(시행)에 대한 random variable(확률변수) $X$가 있고, $X$는 $x_1,…,x_k$의 event(사건, 경우)를 취할 수 있을 때, $x_i$가 일어날 확률은 대문자 $P$를 이용하여 $P(X=x_i)$로 정의한다. 또는 $p_X(X=x_i)$로 표기하거나 간단하게 $p(x_i)$로 표기하기도 한다(세 가지 표현법 모두 같은 의미임). 어떤 사건이 일어날 확률은 항상 0보다 크거나 같으며 1보다 작거나 같다.</p><p>$$0 \leq P(X=x_i) \leq 1$$</p><h2 id="How-to-Define-Probability"><a href="#How-to-Define-Probability" class="headerlink" title="How to Define Probability"></a>How to Define Probability</h2><p>확률은 불확실성을 정량화해주는 도구이다. 불확실성을 정량화할때, 확률을 어떻게 정할지는 매우 중요한 문제이다. 불확실성을 수치로 표현하기 위한 확률은 다음과 같으 세 가지로 정의할 수 있다.</p><ul><li>Classical method</li><li>Frequentist method</li><li>Bayesian method</li></ul><h3 id="Classical-Method"><a href="#Classical-Method" class="headerlink" title="Classical Method"></a>Classical Method</h3><p><strong>Equally Likely Probability</strong></p><p>Sample space에서 모든 event들은 일어날 확률이 같다고 정의하는 방법이다.</p><p>동전 1번 던지는 시행에서 sample space는 앞면, 뒷면만 있다고 가정한다. 그럼 앞면이 나올 확률은 0.5이고, 뒷면이 나올 확률 역시 0.5이라고 정의한다.</p><p>하지만, 이러한 정의에는 문제가 있는데, 내일 날씨가 비가오거나, 맑거나, 우박이 내리는 3가지 경우만 있다고 가정해보자. 이때, classical method에 따르면, 맑을 확률은 0.33, 비가 올 확률도 0.33, 우박이 내릴 확률도 0.33이 된다.</p><p>따라서, classical method 방법은 매우 조심스럽게 사용해야 한다.</p><h3 id="Probability-in-Frequentist-Statistics"><a href="#Probability-in-Frequentist-Statistics" class="headerlink" title="Probability in Frequentist Statistics"></a>Probability in Frequentist Statistics</h3><p><strong>Relative Rates of Events in Infinite Sequence</strong></p><p>어떤 event의 확률을 정의할 때, “수많은 시행 가운데 그 event가 일어난 비율”이라고 정의하는 방법으로, Frequentist statistics에서 확률을 정의하는 방법이다. 즉, 데이터를 기반으로 확률을 정의하는 방법이다.</p><p>예를들어, 동전 던지기에서 앞면이 나올 확률을 계산하고 싶다면, 일단 동전을 무수히 많이 던져본다. 1000번을 던진 후, 651번의 앞면이 나왔다면, 동전 던지기 시행에서 앞면이 나올 확률은 0.651 로 정의하는 것이 Frequentist statistics 에서의 확률 정의이다.</p><p>이 경우, 위 classical method의 문제점을 설명할때 예로 들었던 날씨 예제의 문제는 해결이 된다. 1년동안 우박이 내리는 날은 매우 적기 때문에 우박이 내릴 확률은 매우 작게 측정될 것이다.</p><p>하지만, 이러한 정의에도 문제점이 있다. 어떤 이벤트가 일어날 확률을 계산하기 위해서는 많은 수의 샘플이  필요하고, experiment를 많이 수행해야 한다. 하지만, experiment가 가능한 경우는 실제로 그렇게 많지가 않다.</p><p>예를들어, 내일 비가 올 확률을 구하고 싶다고 해 보자. Frequentist statistics에 따르면, 내일 날씨를 여러번 샘플링 해야 한다. 즉, 내일 날씨를 확인하고, 다시 오늘로 돌아온 후 내일이 되면 날씨를 확인하고, 다시 오늘로 돌아와서 내일이 되면 날씨를 확인하고를 반복해야 한다. 하지만, 알다시피, 이건 타임머신이 있어야 가능하다.</p><h3 id="Probability-in-Bayesian-Statistics"><a href="#Probability-in-Bayesian-Statistics" class="headerlink" title="Probability in Bayesian Statistics"></a>Probability in Bayesian Statistics</h3><p><strong>Personal Perspective</strong></p><p>Bayesian statistics에서 확률을 정의하는 방법으로, 데이터와 함께 event에 대한 개인의 사전 지식을 바탕으로 확률을 정의한다.</p><p>예를 들어, 내일 비가 올 확률을 구할때, 자신이 가지고 있는 데이터 뿐 아니라, 오늘의 날씨를 보고 내일 비가 올 확률이 0.7정도 되겠구나 하는 개인의 믿음을 확률에 반영하게 된다.</p><p>Bayesian statistics에서의 확률의 정의의 특징은, 개인의 사전 지식이 중요하게 작용하며, 많은 양의 데이터를 모으지 않고도 꽤 정확한 추정을 할 수 있게 도와주기도 한다.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;01-Probability&quot;&gt;&lt;a href=&quot;#01-Probability&quot; class=&quot;headerlink&quot; title=&quot;01. Probability&quot;&gt;&lt;/a&gt;01. Probability&lt;/h1&gt;&lt;p&gt;우리는 세상을 살아가는 데 있어서, 
      
    
    </summary>
    
      <category term="베이지안 통계" scheme="https://the-masked-developer.github.io/categories/%EB%B2%A0%EC%9D%B4%EC%A7%80%EC%95%88-%ED%86%B5%EA%B3%84/"/>
    
    
      <category term="베이지안 통계" scheme="https://the-masked-developer.github.io/tags/%EB%B2%A0%EC%9D%B4%EC%A7%80%EC%95%88-%ED%86%B5%EA%B3%84/"/>
    
  </entry>
  
  <entry>
    <title>Nginx 간단 개념 (why 중심)</title>
    <link href="https://the-masked-developer.github.io/wiki/nginx-why/"/>
    <id>https://the-masked-developer.github.io/wiki/nginx-why/</id>
    <published>2021-11-15T04:31:04.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Nginx-보다-먼저-만들어진-Apache-server"><a href="#Nginx-보다-먼저-만들어진-Apache-server" class="headerlink" title="Nginx 보다 먼저 만들어진 Apache server"></a>Nginx 보다 먼저 만들어진 Apache server</h2><p>1995년에 만들어진 Apache 는 많은 클라이언트의 요청을 처리할 수 있게 해주어 많이 사용되었으며, <strong>확장성</strong> 과 <strong>안정성</strong> 이 매우 뛰어남. client 의 요청이 들어올 경우, 미리 fork 해 둔 Process Pool 에서 해당 커넥션을 처리할 Process 를 할당하고 그 프로세스가 요청을 처리하게 됨. (초과 될 경우 fork) 이런 특징은 한 서버가 여러 요청을 처리할 수 있게 만들었으며 개발자들이 다양한 모듈을 작성할 수 있게 했다고 함. </p><h2 id="C10k-시대와-Apache"><a href="#C10k-시대와-Apache" class="headerlink" title="C10k 시대와 Apache"></a>C10k 시대와 Apache</h2><p><strong>C10k</strong> (10,000 Connection problem): 스마트폰의 등장과 인터넷의 활성화로 점점 client 가 많아지면서, 다음과 같은 문제점들에 직면하게 됨.</p><ol><li>TCP Connection 생성의 비용은 비싸다. 그러므로 KeepAlive 로 client 들은 Connection 을 끊지 않기 시작했다.</li><li>Process 생성에는 메모리가 필요하다. Connection 의 수 = 메모리 필요량이 비례하면서 부족지기 시작했다.</li><li>Request 를 처리하기 위해 Process 를 switching 하는 context switching 비용도 비싸다.</li></ol><p>그래서 위 문제를 해결하고자 Apache 진영도 많은 고민을 하고 개선해나가고 있으며, 새로운 구조로 만들어진 게 Nginx 이다.</p><h2 id="Nginx-의-특장점"><a href="#Nginx-의-특장점" class="headerlink" title="Nginx 의 특장점"></a>Nginx 의 특장점</h2><p><strong>Event Driven</strong> 구조이다. Nginx 에서 Event 란, Connection 의 생성, 제거, 처리 등을 말한다. Nginx 에는 Master Process 와 그것이 생성하는 Worker Process 가 있는데, Worker 는 Event 를 기다렸다가 처리한다. 처리는 Worker Process 의 Thread Pool 의 Thread 에게 맡기므로, 혹시 Event 늖 Blocking 이므로 처리중 I/O 등으로 오래걸리는 Event 가 있을 경우도 동시에 처리가 가능하다.</p><p>개략적인 구조의 변경은 위와 같고, 정리해서/ 추가적으로 특장점은 다음과 같다.</p><ul><li>하나의 Worker Process 가 많은 Connection Event 을 처리할 수 있게 되었다.</li><li>적은 Worker Process 의 수를 가지기 때문에, (보통 코어개수) 메모리 사용량이 적다. (요청이 늘어도 Thread stack 크기 정도의 메모리 추가사용)</li><li>I/O 가 많이 필요한 Blocking 작업들 또한 효율적으로 처리하게 되었다.</li><li>Worker Process 를 새로 띄우고 Event 를 맡기면 되므로, 동적으로 설정변경이 가능하게 되었다. (최 앞단에서 로드밸런싱등을 수행할 때 Single Point 잉므로 이 기능은 매우 핵심)</li></ul><h2 id="Nginx-의-기능"><a href="#Nginx-의-기능" class="headerlink" title="Nginx 의 기능"></a>Nginx 의 기능</h2><p><a href="https://nginx.org/en/">https://nginx.org/en/</a></p><ul><li>정적파일 서빙, 및 오토인덱싱, open fd 캐싱? 등</li><li>리버스 프록시서버로써 동작 및 캐싱.</li><li>로드밸런싱, fault tolerance</li><li>filter 로써, 데이터 압축, 변환, …</li><li>SSL Termination - SSL 처리 부담을 로직서버에 안가게끔 앞단에서 처리</li><li>CORS / HTTP/2 등</li></ul><h2 id="참고자료"><a href="#참고자료" class="headerlink" title="참고자료"></a>참고자료</h2><ul><li><a href="https://nginx.org/en/">Nginx official docs</a></li><li><a href="https://www.youtube.com/watch?v=6FAwAXXj5N0">우아한 형제들 10분 테코톡</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Nginx-보다-먼저-만들어진-Apache-server&quot;&gt;&lt;a href=&quot;#Nginx-보다-먼저-만들어진-Apache-server&quot; class=&quot;headerlink&quot; title=&quot;Nginx 보다 먼저 만들어진 Apache server&quot;&gt;
      
    
    </summary>
    
      <category term="프로그래밍" scheme="https://the-masked-developer.github.io/categories/%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/"/>
    
    
  </entry>
  
  <entry>
    <title>NestJS dynamic module 직접 만들어보기</title>
    <link href="https://the-masked-developer.github.io/wiki/%5Bnestjs%5Ddynamic-module/"/>
    <id>https://the-masked-developer.github.io/wiki/[nestjs]dynamic-module/</id>
    <published>2021-11-12T10:00:22.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h3 id="소개"><a href="#소개" class="headerlink" title="소개"></a>소개</h3><hr><p><em>A module is a class annotated with a <code>@Module()</code> decorator. The <code>@Module()</code> decorator provides metadata that <strong>Nest</strong> makes use of to organize the application structure.</em></p><p>Nest 에서는 <code>@Module()</code> 데코레이터를 이용해 모듈 클래스를 생성하고 등록할 수 있다.</p><p>특히 동적 모듈 (Dynamic Module) 기능을 이용해서 Provider 를 동적으로 등록하고 구성 할 수 있는 커스텀 가능한 모듈을 쉽게 만들 수 있다.</p><p>Nestjs에서 공식적으로 지원하는 JwtModule 을 분석해보고, 직접 만들어보는 과정을 정리해보자.</p><h3 id="분석"><a href="#분석" class="headerlink" title="분석"></a>분석</h3><hr><p>먼저 JwtModule 이 어떻게 사용되는지 살펴보겠다.</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// auth.module.ts</span><br><span class="hljs-comment">// https://github.com/nestjs/nest/blob/master/sample/19-auth-jwt/src/auth/auth.module.ts</span><br><br><span class="hljs-keyword">import</span> &#123; JwtModule &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/jwt&#x27;</span>;<br><br>@Module(&#123;<br>  <span class="hljs-attr">imports</span>: [<br>    UsersModule,<br>    PassportModule,<br>    JwtModule.register(&#123;<br>      <span class="hljs-attr">secret</span>: jwtConstants.secret,<br>      <span class="hljs-attr">signOptions</span>: &#123; <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&#x27;60s&#x27;</span> &#125;,<br>    &#125;),<br>  ],<br>  <span class="hljs-attr">providers</span>: [AuthService, LocalStrategy, JwtStrategy],<br>  <span class="hljs-attr">exports</span>: [AuthService],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthModule</span> </span>&#123;&#125;<br></code></pre></td></tr></table></figure><p>NestJS 공식 샘플 코드중 JwtModule 이 등록되는 부분이다.</p><p>module.register(options) 와 같은 형태로 사용할 모듈의 static method 를 옵션과 함께 호출하여<br>동적으로 프로바이더를 생성한다.</p><p>위와 같이 등록해주면 아래와 같이 jwtService 를 이용할 수 있게 된다</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// auth.service.ts</span><br><span class="hljs-comment">// https://github.com/nestjs/nest/blob/master/sample/19-auth-jwt/src/auth/auth.service.ts</span><br><br><span class="hljs-keyword">import</span> &#123; Injectable &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; UsersService &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../users/users.service&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; JwtService &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/jwt&#x27;</span>;<br><br>@Injectable()<br><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthService</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">    private readonly usersService: UsersService,</span></span><br><span class="hljs-params"><span class="hljs-function">    private readonly jwtService: JwtService,</span></span><br><span class="hljs-params"><span class="hljs-function">  </span>)</span> &#123;&#125;<br><br>  <span class="hljs-keyword">async</span> validateUser(username: string, <span class="hljs-attr">pass</span>: string): <span class="hljs-built_in">Promise</span>&lt;any&gt; &#123;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.usersService.findOne(username);<br>    <span class="hljs-keyword">if</span> (user &amp;&amp; user.password === pass) &#123;<br>      <span class="hljs-keyword">const</span> &#123; password, ...result &#125; = user;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">login</span>(<span class="hljs-params">user: any</span>)</span> &#123;<br>    <span class="hljs-keyword">const</span> payload = &#123; <span class="hljs-attr">username</span>: user.username, <span class="hljs-attr">sub</span>: user.userId &#125;;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">access_token</span>: <span class="hljs-built_in">this</span>.jwtService.sign(payload),<br>    &#125;;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>그럼 이제 JwtModule 이 어떻게 정의되어있는지 살펴보자.</p><p><a href="https://github.com/nestjs/jwt/tree/master/lib">https://github.com/nestjs/jwt/tree/master/lib</a></p><p>폴더구조는 아래와 같다.</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx">lib<br>├── interfaces<br>├── index.ts<br>├── jwt.constants.ts<br>├── jwt.module.ts<br>├── jwt.providers.ts<br>└── jwt.service.ts<br></code></pre></td></tr></table></figure><p>가장 먼저 등록되는 부분을 담당하는 jwt.module.ts 파일을 살펴보자.</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; DynamicModule, Module, Provider &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123;<br>  JwtModuleAsyncOptions,<br>  JwtModuleOptions,<br>  JwtOptionsFactory<br>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./interfaces/jwt-module-options.interface&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; JWT_MODULE_OPTIONS &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./jwt.constants&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createJwtProvider &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./jwt.providers&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; JwtService &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./jwt.service&#x27;</span>;<br><br>@Module(&#123;<br>  <span class="hljs-attr">providers</span>: [JwtService],<br>  <span class="hljs-attr">exports</span>: [JwtService]<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtModule</span> </span>&#123;<br>  <span class="hljs-keyword">static</span> register(options: JwtModuleOptions): DynamicModule &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">module</span>: JwtModule,<br>      <span class="hljs-attr">providers</span>: createJwtProvider(options)<br>    &#125;;<br>  &#125;<br><br>  <span class="hljs-keyword">static</span> registerAsync(options: JwtModuleAsyncOptions): DynamicModule &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">module</span>: JwtModule,<br>      <span class="hljs-attr">imports</span>: options.imports || [],<br>      <span class="hljs-attr">providers</span>: <span class="hljs-built_in">this</span>.createAsyncProviders(options)<br>    &#125;;<br>  &#125;<br><br>  private <span class="hljs-keyword">static</span> createAsyncProviders(<br>    options: JwtModuleAsyncOptions<br>  ): Provider[] &#123;<br>    <span class="hljs-keyword">if</span> (options.useExisting || options.useFactory) &#123;<br>      <span class="hljs-keyword">return</span> [<span class="hljs-built_in">this</span>.createAsyncOptionsProvider(options)];<br>    &#125;<br>    <span class="hljs-keyword">return</span> [<br>      <span class="hljs-built_in">this</span>.createAsyncOptionsProvider(options),<br>      &#123;<br>        <span class="hljs-attr">provide</span>: options.useClass,<br>        <span class="hljs-attr">useClass</span>: options.useClass<br>      &#125;<br>    ];<br>  &#125;<br><br>  private <span class="hljs-keyword">static</span> createAsyncOptionsProvider(<br>    options: JwtModuleAsyncOptions<br>  ): Provider &#123;<br>    <span class="hljs-keyword">if</span> (options.useFactory) &#123;<br>      <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-attr">provide</span>: JWT_MODULE_OPTIONS,<br>        <span class="hljs-attr">useFactory</span>: options.useFactory,<br>        <span class="hljs-attr">inject</span>: options.inject || []<br>      &#125;;<br>    &#125;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">provide</span>: JWT_MODULE_OPTIONS,<br>      <span class="hljs-attr">useFactory</span>: <span class="hljs-keyword">async</span> (optionsFactory: JwtOptionsFactory) =&gt;<br>        <span class="hljs-keyword">await</span> optionsFactory.createJwtOptions(),<br>      <span class="hljs-attr">inject</span>: [options.useExisting || options.useClass]<br>    &#125;;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>이 중 NestJS 공식 샘플에서 사용된 register method  와 관련된 부분을 살펴보면 아래와 같다</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx">@Module(&#123;<br>  <span class="hljs-attr">providers</span>: [JwtService],<br>  <span class="hljs-attr">exports</span>: [JwtService]<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtModule</span> </span>&#123;<br><span class="hljs-keyword">static</span> register(options: JwtModuleOptions): DynamicModule &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">module</span>: JwtModule,<br>      <span class="hljs-attr">providers</span>: createJwtProvider(options)<br>    &#125;;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createJwtProvider</span>(<span class="hljs-params">options: JwtModuleOptions</span>): <span class="hljs-title">any</span>[] </span>&#123;<br>  <span class="hljs-keyword">return</span> [&#123; <span class="hljs-attr">provide</span>: JWT_MODULE_OPTIONS, <span class="hljs-attr">useValue</span>: options || &#123;&#125; &#125;];<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> JWT_MODULE_OPTIONS = <span class="hljs-string">&#x27;JWT_MODULE_OPTIONS&#x27;</span>;<br></code></pre></td></tr></table></figure><p>register 함수는 JwtService 가 provide 되고, export 된 JwtModule 을 사용할 수 있도록<br>NestJS 모듈 객체 형태로 리턴해준다.</p><p>이때 사용자가 입력한 옵션을 파라미터로 받아 동적 프로바이더를 생성해 주기 때문에</p><p>이 모듈을 사용하는 모든 곳에서 같은 암호화 옵션, 비밀키 등을 공유 할 수 있게 해준다.</p><p>또한, registerAsync 라는 다른 등록 구문을 활용해서 useClass, useExisting, useFactory 같은 구문을 이용해 다른 클래스를 추가로 이용하거나, 이미 존재하는 프로바이더를 alias 해서 사용하거나, 비동기적으로 생성 또한 가능하다.</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">static</span> registerAsync(options: JwtModuleAsyncOptions): DynamicModule &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">module</span>: JwtModule,<br>      <span class="hljs-attr">imports</span>: options.imports || [],<br>      <span class="hljs-attr">providers</span>: <span class="hljs-built_in">this</span>.createAsyncProviders(options)<br>    &#125;;<br>  &#125;<br><br>  private <span class="hljs-keyword">static</span> createAsyncProviders(<br>    options: JwtModuleAsyncOptions<br>  ): Provider[] &#123;<br>    <span class="hljs-keyword">if</span> (options.useExisting || options.useFactory) &#123;<br>      <span class="hljs-keyword">return</span> [<span class="hljs-built_in">this</span>.createAsyncOptionsProvider(options)];<br>    &#125;<br>    <span class="hljs-keyword">return</span> [<br>      <span class="hljs-built_in">this</span>.createAsyncOptionsProvider(options),<br>      &#123;<br>        <span class="hljs-attr">provide</span>: options.useClass,<br>        <span class="hljs-attr">useClass</span>: options.useClass<br>      &#125;<br>    ];<br>  &#125;<br><br>  private <span class="hljs-keyword">static</span> createAsyncOptionsProvider(<br>    options: JwtModuleAsyncOptions<br>  ): Provider &#123;<br>    <span class="hljs-keyword">if</span> (options.useFactory) &#123;<br>      <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-attr">provide</span>: JWT_MODULE_OPTIONS,<br>        <span class="hljs-attr">useFactory</span>: options.useFactory,<br>        <span class="hljs-attr">inject</span>: options.inject || []<br>      &#125;;<br>    &#125;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">provide</span>: JWT_MODULE_OPTIONS,<br>      <span class="hljs-attr">useFactory</span>: <span class="hljs-keyword">async</span> (optionsFactory: JwtOptionsFactory) =&gt;<br>        <span class="hljs-keyword">await</span> optionsFactory.createJwtOptions(),<br>      <span class="hljs-attr">inject</span>: [options.useExisting || options.useClass]<br>    &#125;;<br>  &#125;<br></code></pre></td></tr></table></figure><p>Dynamic 모듈을 만들기 위한 필요 요건을 정리해보면 아래와 같다.</p><ol><li>모듈을 등록할 수 있는 static register, static registerAsync 메소드가 포함된 모듈 클래스</li><li>모듈에서 제공할 서비스로직이 포함된 주입 가능한 서비스 클래스</li><li>동적으로 넘겨지는 객체를 주입받아 사용할 수 있도록 미리 선언된 상수와 동적 프로바이더 생성 로직</li></ol><h3 id="직접-만들어보기"><a href="#직접-만들어보기" class="headerlink" title="직접 만들어보기"></a>직접 만들어보기</h3><hr><p>NodeJS 에서 기본으로 제공하는 util 라이브러리중 inspect 라는 메소드가 있다.</p><p><a href="https://nodejs.org/api/util.html#utilinspectobject-options">https://nodejs.org/api/util.html#utilinspectobject-options</a></p><p>이를 래핑하는 동적 모듈을 만들어보자</p><p>The <code>util.inspect()</code> method returns a string representation of <code>object</code> that is intended for debugging. The output of <code>util.inspect</code> may change at any time and should not be depended upon programmatically. Additional <code>options</code> may be passed that alter the result. <code>util.inspect()</code> will use the constructor’s name and/or <code>@@toStringTag</code> to make an identifiable tag for an inspected value.</p><p>이 메소드는 javscript object 디버깅하거나, 읽기 쉽게 변형해서 string 으로 리턴해주는 유틸 메소드다.</p><p>아래 예시처럼 동작한다.</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br><br><span class="hljs-keyword">const</span> o = &#123;<br>  <span class="hljs-attr">a</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, [[<br>    <span class="hljs-string">&#x27;Lorem ipsum dolor sit amet,\nconsectetur adipiscing elit, sed do &#x27;</span> +<br>      <span class="hljs-string">&#x27;eiusmod \ntempor incididunt ut labore et dolore magna aliqua.&#x27;</span>,<br>    <span class="hljs-string">&#x27;test&#x27;</span>,<br>    <span class="hljs-string">&#x27;foo&#x27;</span>]], <span class="hljs-number">4</span>],<br>  <span class="hljs-attr">b</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>([[<span class="hljs-string">&#x27;za&#x27;</span>, <span class="hljs-number">1</span>], [<span class="hljs-string">&#x27;zb&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>]])<br>&#125;;<br><span class="hljs-built_in">console</span>.log(util.inspect(o, &#123; <span class="hljs-attr">compact</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">depth</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">breakLength</span>: <span class="hljs-number">80</span> &#125;));<br><br><span class="hljs-comment">// &#123; a:</span><br><span class="hljs-comment">//   [ 1,</span><br><span class="hljs-comment">//     2,</span><br><span class="hljs-comment">//     [ [ &#x27;Lorem ipsum dolor sit amet,\nconsectetur [...]&#x27;, // A long line</span><br><span class="hljs-comment">//           &#x27;test&#x27;,</span><br><span class="hljs-comment">//           &#x27;foo&#x27; ] ],</span><br><span class="hljs-comment">//     4 ],</span><br><span class="hljs-comment">//   b: Map(2) &#123; &#x27;za&#x27; =&gt; 1, &#x27;zb&#x27; =&gt; &#x27;test&#x27; &#125; &#125;</span><br></code></pre></td></tr></table></figure><p>먼저, 필요 요건들을 만들기 전에 어떻게 등록할지 정의해보자.</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; Module &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; InspectModule &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./inspect/inspect.module&#x27;</span>;<br><br>@Module(&#123;<br>  <span class="hljs-attr">imports</span>: [<br>    UsersModule,<br>    PassportModule,<br>    JwtModule.register(&#123;<br>      <span class="hljs-attr">secret</span>: jwtConstants.secret,<br>      <span class="hljs-attr">signOptions</span>: &#123; <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&#x27;60s&#x27;</span> &#125;,<br>    &#125;),<br>    InspectModule.register(&#123;<span class="hljs-attr">showHidden</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">depth</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">colors</span>: <span class="hljs-literal">true</span>&#125;),<br>  ],<br>  <span class="hljs-attr">providers</span>: [AuthService, LocalStrategy, JwtStrategy],<br>  <span class="hljs-attr">exports</span>: [AuthService],<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthModule</span> </span>&#123;&#125;<br></code></pre></td></tr></table></figure><p>맨 처음 JwtModule 을 어떻게 등록하는지 살펴 봤던 그 파일이다.<br>JwtModule 아래에 InspectModule을 등록하는 부분을 추가해주었다.</p><p>이제 필요요건들을 하나씩 만들어보자.</p><ul><li>모듈을 등록할 수 있는 static register, static registerAsync 메소드가 포함된 모듈 클래스</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; DynamicModule, Module, Provider &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; INSPECT_MODULE_OPTION &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./inspect.constants&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; InspectAsyncOptions, InspectOptions, InspectOptionsFactory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./inspect.interfaces&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createInspectProviders &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./inspect.providers&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; InspectService &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./inspect.service&#x27;</span>;<br><br>@Module(&#123;<br>  <span class="hljs-attr">providers</span>: [InspectService],<br>  <span class="hljs-attr">exports</span>: [InspectService]<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InspectModule</span> </span>&#123;<br>  public <span class="hljs-keyword">static</span> register(options: InspectOptions): DynamicModule &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">module</span>: InspectModule,<br>      <span class="hljs-attr">providers</span>: createInspectProviders(options),<br>    &#125;;<br>  &#125;<br><br>  <span class="hljs-keyword">static</span> registerAsync(options: InspectAsyncOptions): DynamicModule &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">module</span>: InspectModule,<br>      <span class="hljs-attr">imports</span>: options.imports || [],<br>      <span class="hljs-attr">providers</span>: <span class="hljs-built_in">this</span>.createAsyncProviders(options)<br>    &#125;;<br>  &#125;<br><br>  private <span class="hljs-keyword">static</span> createAsyncProviders(<br>    options: InspectAsyncOptions<br>  ): Provider[] &#123;<br>    <span class="hljs-keyword">if</span> (options.useExisting || options.useFactory) &#123;<br>      <span class="hljs-keyword">return</span> [<span class="hljs-built_in">this</span>.createAsyncOptionsProvider(options)];<br>    &#125;<br>    <span class="hljs-keyword">return</span> [<br>      <span class="hljs-built_in">this</span>.createAsyncOptionsProvider(options),<br>      &#123;<br>        <span class="hljs-attr">provide</span>: options.useClass,<br>        <span class="hljs-attr">useClass</span>: options.useClass<br>      &#125;<br>    ];<br>  &#125;<br><br>  private <span class="hljs-keyword">static</span> createAsyncOptionsProvider(<br>    options: InspectAsyncOptions<br>  ): Provider &#123;<br>    <span class="hljs-keyword">if</span> (options.useFactory) &#123;<br>      <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-attr">provide</span>: INSPECT_MODULE_OPTION,<br>        <span class="hljs-attr">useFactory</span>: options.useFactory,<br>        <span class="hljs-attr">inject</span>: options.inject || []<br>      &#125;;<br>    &#125;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">provide</span>: INSPECT_MODULE_OPTION,<br>      <span class="hljs-attr">useFactory</span>: <span class="hljs-keyword">async</span> (optionsFactory: InspectOptionsFactory) =&gt;<br>        <span class="hljs-keyword">await</span> optionsFactory.createInspectOptions(),<br>      <span class="hljs-attr">inject</span>: [options.useExisting || options.useClass]<br>    &#125;;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>모듈에서 제공할 서비스로직이 포함된 주입 가능한 서비스 클래스</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; Inject, Injectable &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;<br><span class="hljs-keyword">import</span> util, &#123; InspectOptions &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;util&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; INSPECT_MODULE_OPTION &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./inspect.constants&#x27;</span>;<br><br>@Injectable()<br><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InspectService</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">@Inject(INSPECT_MODULE_OPTION) private readonly options: InspectOptions</span>)</span> &#123;&#125;<br><br>    inspect(object: any): string &#123;<br>        <span class="hljs-keyword">return</span> util.inspect(object, <span class="hljs-built_in">this</span>.options)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>동적으로 넘겨지는 객체를 주입받아 사용할 수 있도록 미리 선언된 상수와 동적 프로바이더 생성 로직</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; Provider &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; INSPECT_MODULE_OPTION &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./inspect.constants&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; InspectOptions &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./inspect.interfaces&quot;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createInspectProviders</span>(<span class="hljs-params">options: InspectOptions</span>): <span class="hljs-title">Provider</span>[] </span>&#123;<br>    <span class="hljs-keyword">return</span> [<br>      &#123;<br>        <span class="hljs-attr">provide</span>: INSPECT_MODULE_OPTION,<br>        <span class="hljs-attr">useValue</span>: options || &#123;&#125;,<br>      &#125;,<br>    ];<br>  &#125;<br></code></pre></td></tr></table></figure><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; ModuleMetadata, Type &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; InspectOptions &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;util&#x27;</span>;<br><br><span class="hljs-keyword">const</span> INSPECT_MODULE_OPTION = <span class="hljs-string">&quot;INSPECT_MODULE_OPTION&quot;</span><br><br><span class="hljs-keyword">export</span> &#123; INSPECT_MODULE_OPTION &#125;<br></code></pre></td></tr></table></figure><p>sample src : <a href="https://github.com/seonjl/nestjs-inspect/tree/main/sample">https://github.com/seonjl/nestjs-inspect/tree/main/sample</a></p><p>참고한 레퍼런스 </p><ul><li><a href="https://dev.to/nestjs/advanced-nestjs-how-to-build-completely-dynamic-nestjs-modules-1370">https://dev.to/nestjs/advanced-nestjs-how-to-build-completely-dynamic-nestjs-modules-1370</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;소개&quot;&gt;&lt;a href=&quot;#소개&quot; class=&quot;headerlink&quot; title=&quot;소개&quot;&gt;&lt;/a&gt;소개&lt;/h3&gt;&lt;hr&gt;
&lt;p&gt;&lt;em&gt;A module is a class annotated with a &lt;code&gt;@Module()&lt;/code&gt; d
      
    
    </summary>
    
      <category term="nodejs" scheme="https://the-masked-developer.github.io/categories/nodejs/"/>
    
    
      <category term="nestjs" scheme="https://the-masked-developer.github.io/tags/nestjs/"/>
    
  </entry>
  
  <entry>
    <title>타입스크립트로 좋은 테스트 작성하기</title>
    <link href="https://the-masked-developer.github.io/wiki/wellmade-test-writing/"/>
    <id>https://the-masked-developer.github.io/wiki/wellmade-test-writing/</id>
    <published>2021-11-10T13:22:22.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h2 id="좋은-테스트-코드를-작성하는-원칙"><a href="#좋은-테스트-코드를-작성하는-원칙" class="headerlink" title="좋은 테스트 코드를 작성하는 원칙"></a>좋은 테스트 코드를 작성하는 원칙</h2><p>깨끗한 테스트 코드는 신뢰할 수 있는 개발과 배포를 가능하게 합니다!</p><h3 id="직관적이고-이해가-되는-테스트-이름으로-구성하기"><a href="#직관적이고-이해가-되는-테스트-이름으로-구성하기" class="headerlink" title="직관적이고 이해가 되는 테스트 이름으로 구성하기"></a>직관적이고 이해가 되는 테스트 이름으로 구성하기</h3><hr><ul><li>테스트 이름을 추상적으로 쓰지마세요.</li><li>정확히 무엇을 테스트 하는지 명시적으로 작성하세요.</li></ul><p>🟥 <strong>안좋은 예</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">describe(<span class="hljs-string">&quot;주문 검증&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> postOrder = &#123; ... &#125;;<br>  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> service.addOrder(postOrder);<br>  expect(order).toEqual()<br>&#125;);<br></code></pre></td></tr></table></figure><hr><p><strong>🟦 좋은 예</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">describe(<span class="hljs-string">&quot;정상적인 주문이 추가되는지 검증합니다.&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> postOrder = &#123; ... &#125;;<br>  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> service.addOrder(postOrder);<br>  expect(order).toEqual()<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="글로벌-테스트-픽스처를-작성하지-마세요"><a href="#글로벌-테스트-픽스처를-작성하지-마세요" class="headerlink" title="글로벌 테스트 픽스처를 작성하지 마세요"></a>글로벌 테스트 픽스처를 작성하지 마세요</h3><ul><li>복잡하고 이해하기 힘든 테스트 픽스처는 쉽게 추론하기가 힘듭니다.</li><li>테스트의 결합도가 증가하는 건 좋지 않습니다.</li><li>반복 사용되는 픽스처가 있다면, 외부에 static 팩토리 메소드를 만드세요.</li></ul><p>🟥 <strong>안좋은 예</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx">beforeAll(<span class="hljs-keyword">async</span> () =&gt; &#123;<br><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> service.addUser();<br><span class="hljs-keyword">const</span> money = <span class="hljs-keyword">await</span> service.addMoney(user);<br><span class="hljs-keyword">await</span> service.addOrder(user, money);<br>&#125;);<br>describe(<span class="hljs-string">&quot;주문을 취소합니다&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> service.deleteOrder();<br>  expect(order.status).toBe(<span class="hljs-string">&quot;canceled&quot;</span>)<br>&#125;);<br></code></pre></td></tr></table></figure><hr><p><strong>🟦 좋은 예</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestFactory</span> </span>&#123;  <br><span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">create</span>(<span class="hljs-params"></span>)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ~~()<br>&#125;<br>&#125;<br><br>describe(<span class="hljs-string">&quot;정상적인 주문이 추가되는지 검증합니다.&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br><span class="hljs-keyword">const</span> user = TestFactory.createUser()<br><span class="hljs-keyword">const</span> money = TestFactory.createMoney() <br>  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> service.addOrder(user, money);<br>  expect(order.status).toBe(<span class="hljs-string">&quot;canceled&quot;</span>)<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="테스트를-반드시-격리시키세요"><a href="#테스트를-반드시-격리시키세요" class="headerlink" title="테스트를 반드시 격리시키세요"></a>테스트를 반드시 격리시키세요</h3><ul><li>하나의 테스트는 반드시 격리되어 실행되어 외부에 영향을 받지 않아야 합니다.</li></ul><p>🟥 <strong>안좋은 예</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> addOrder<br>describe(<span class="hljs-string">&quot;주문을 추가합니다&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> service.addOrder();<br>addOrder = order;<br>  expect(order.status).toBe(<span class="hljs-string">&quot;added&quot;</span>)<br>&#125;);<br><br>describe(<span class="hljs-string">&quot;주문을 취소합니다&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> service.deleteOrder(addOrder);<br>  expect(order.status).toBe(<span class="hljs-string">&quot;canceled&quot;</span>)<br>&#125;);<br></code></pre></td></tr></table></figure><hr><p><strong>🟦 좋은 예</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx">describe(<span class="hljs-string">&quot;주문을 추가합니다&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> service.addOrder();<br>  expect(order.status).toBe(<span class="hljs-string">&quot;added&quot;</span>)<br>&#125;);<br><br>describe(<span class="hljs-string">&quot;주문을 취소합니다&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> addOrder = <span class="hljs-keyword">await</span> service.addOrder();<br>  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> service.deleteOrder(addOrder);<br>  expect(order.status).toBe(<span class="hljs-string">&quot;canceled&quot;</span>)<br>&#125;);<br></code></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;좋은-테스트-코드를-작성하는-원칙&quot;&gt;&lt;a href=&quot;#좋은-테스트-코드를-작성하는-원칙&quot; class=&quot;headerlink&quot; title=&quot;좋은 테스트 코드를 작성하는 원칙&quot;&gt;&lt;/a&gt;좋은 테스트 코드를 작성하는 원칙&lt;/h2&gt;&lt;p&gt;깨끗한 테스
      
    
    </summary>
    
      <category term="글쓰기" scheme="https://the-masked-developer.github.io/categories/%EA%B8%80%EC%93%B0%EA%B8%B0/"/>
    
    
      <category term="글쓰기" scheme="https://the-masked-developer.github.io/tags/%EA%B8%80%EC%93%B0%EA%B8%B0/"/>
    
  </entry>
  
  <entry>
    <title>Supervisord 찍어먹기</title>
    <link href="https://the-masked-developer.github.io/wiki/Supervisord/"/>
    <id>https://the-masked-developer.github.io/wiki/Supervisord/</id>
    <published>2021-11-09T14:05:19.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Supervisor"><a href="#Supervisor" class="headerlink" title="Supervisor"></a>Supervisor</h2><p>supervisord 또는 supervisordctl command 는 기본적으로 다음과 같은 경로에서 순서대로 <code>supervisord.conf</code> 을 찾는다.</p><ul><li>../etc/supervisord.conf (Relative to the executable)</li><li>../supervisord.conf (Relative to the executable)</li><li>$CWD/supervisord.conf</li><li>$CWD/etc/supervisord.conf</li><li>/etc/supervisord.conf</li><li>/etc/supervisor/supervisord.conf (since Supervisor 3.3.0)</li></ul><p>우선 다음과 같이 예제 어플리케이션을 생성했다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Starting application...&quot;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;i&#125;</span>] working...&quot;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># docker-compose.yml</span><br><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.8&quot;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">app:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">python:latest</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./app.py:/app.py&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/app.py</span><br></code></pre></td></tr></table></figure><p>실행 할 경우.</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs prolog">~/<span class="hljs-symbol">Dropbox</span>/box/demos/supervisord master* ⇣⇡ ❯ dc up<br><span class="hljs-symbol">Starting</span> supervisord_app_1 ... done<br><span class="hljs-symbol">Attaching</span> to supervisord_app_1<br>app_1  | <span class="hljs-symbol">Starting</span> application...<br>app_1  | [<span class="hljs-number">0</span>] working...<br>app_1  | [<span class="hljs-number">1</span>] working...<br>app_1  | [<span class="hljs-number">2</span>] working...<br>app_1  | [<span class="hljs-number">3</span>] working...<br>app_1  | [<span class="hljs-number">4</span>] working...<br>supervisord_app_1 exited with code <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>작업을 마친 후 자동으로 종료된다.</p><p>이제 supervisord.conf 를 생성한다. 파일 형식은 윈도우즈의 <code>ini</code> 로써 각 섹션은 <code>[HEADER]</code> 로 나타내며<br>섹션안에 <code>Key=Value</code> 페어가 들어간다. 공식 홈페이지를 보고 처음부터 한땀한땀 해도 되겠지만 공식 레포의 <a href="https://github.com/Supervisor/supervisor/blob/master/supervisor/skel/sample.conf">샘플</a> 로 시작하는게 좋을듯 하다.<br>(set filetype=dosini 로 문법 하이라이팅을 켤 수 있다.)</p><p><img src="https://minhyeoky.github.io/posts/supervisor/img/supervisord.conf.png" alt="supervisord.conf"></p><ul><li>HTTP 서버를 돌릴게 아니므로, <code>unix_http_server</code> 및 <code>inet_http_server</code> 는 지운다.</li><li><code>supervisord</code> 는 supervisord 프로세스에 대한 설정이므로 냅둔다.</li><li>rpc 또한 해당사항이 없으므로 <code>rpcinterface</code> 도 지운다.</li><li><code>supervisorctl</code> 의 경우 쉘 커맨드 설정을 위함인데, 유저별로 권한을 주는 등 설정할 필요는 없으므로 지운다.</li><li><code>include</code> 는 다른 supervisord.conf 파일을 포함시킬 수 있게 해준다. 지운다.</li><li><code>group</code> 은 program 들을 묶을 수 있게 해준다. 지운다.</li><li><code>eventlistener</code> 는 supervisor’s event system. 로부터 이벤트를 받을 수 있는 프로그램이다. 지운다.</li></ul><p>supervisor 는 python 으로 구현되어 있으므로 pip 로 설치한다. 그러므로 Dockerfile 을 생성하고<br>설치하도록 했다. (버퍼를 꺼줘야 컨테이너 로그가 바로 보인다.)</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> python:latest<br><br><span class="hljs-keyword">ENV</span> PYTHONUNBUFFERED <span class="hljs-number">1</span><br><br><span class="hljs-keyword">RUN</span><span class="bash"> pip install supervisor</span><br></code></pre></td></tr></table></figure><p>supervisor.conf 파일을 docker-compose.yml 의 volume 에 추가한다.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">app:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">./</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./app.py:/app.py&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./supervisord.conf:/etc/supervisord.conf&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">supervisord</span><br><br></code></pre></td></tr></table></figure><p>이렇게 실행 할 경우 nodaemon 값을 true 로 해줘야한다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dosini">[program:app]<br>  command=/app.py              ; the program (relative uses PATH, can take args)<br></code></pre></td></tr></table></figure><p>이제 다시 실행할 경우 app 의 로그는 보이지 않지만 정상적으로 종료되었음을 알 수 있다. </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">app_1</span>  | /usr/lib/python<span class="hljs-number">3</span>/dist-packages/supervisor/options.py:<span class="hljs-number">474</span>: UserWarning: Supervisord is running as root and it is searching for its configuration file in default locations (including its current working directory); you probably want to specify a <span class="hljs-string">&quot;-c&quot;</span> argument specifying an absolute path to a configuration file for improved security.<br><span class="hljs-attribute">app_1</span>  |   self.warnings.warn(<br><span class="hljs-attribute">app_1</span>  | <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">01</span>:<span class="hljs-number">47</span>,<span class="hljs-number">610</span> CRIT Supervisor is running as root.  Privileges were not dropped because no user is specified in the config file.  If you intend to run as root, you can set user=root in the config file to avoid this message.<br><span class="hljs-attribute">app_1</span>  | <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">01</span>:<span class="hljs-number">47</span>,<span class="hljs-number">613</span> INFO supervisord started with pid <span class="hljs-number">1</span><br><span class="hljs-attribute">app_1</span>  | <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">01</span>:<span class="hljs-number">48</span>,<span class="hljs-number">616</span> INFO spawned: &#x27;app&#x27; with pid <span class="hljs-number">8</span><br><span class="hljs-attribute">app_1</span>  | <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">01</span>:<span class="hljs-number">49</span>,<span class="hljs-number">707</span> INFO success: app entered RUNNING state, process has stayed up for &gt; than <span class="hljs-number">1</span> seconds (startsecs)<br><span class="hljs-attribute">app_1</span>  | <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">01</span>:<span class="hljs-number">51</span>,<span class="hljs-number">714</span> INFO exited: app (exit status <span class="hljs-number">0</span>; expected)<br></code></pre></td></tr></table></figure><p>로그는 stdout_logfile 을 통해서 std 또는 file 에 쓰면 된다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dosini">[supervisord]<br>  stdout_logfile=/dev/stdout        ; stdout log path, NONE for none; default AUTO<br>  stdout_logfile_maxbytes=0   ; max # logfile bytes b4 rotation (default 50MB)<br></code></pre></td></tr></table></figure><p>program 의 auturestart 의 기본값은 unexpected 로써 exit code 0 이 아닌 경우 재시작한다. 그러므로<br>app.py 에서 sys.exit(1) 로 비정상 종료 코드를 내보낸다면 supervisord 가 프로세스를 재시작해준다.</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">app_1  | <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">11</span>,<span class="hljs-number">750</span> INFO spawned: <span class="hljs-string">&#x27;app&#x27;</span> with pid <span class="hljs-number">1819</span><br>app_1  | Starting application...<br>app_1  | [<span class="hljs-number">0</span>] working...<br>^[app_1  | <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">12</span>,<span class="hljs-number">783</span> INFO success: app entered RUNNING state, process has stayed up <span class="hljs-keyword">for</span> &gt; than <span class="hljs-number">1</span> seconds (startsecs)<br>app_1  | [<span class="hljs-number">1</span>] working...<br>app_1  | [<span class="hljs-number">2</span>] working...<br><br>app_1  | <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">14</span>,<span class="hljs-number">862</span> INFO exited: app (<span class="hljs-keyword">exit</span> status <span class="hljs-number">1</span>; not expected)<br>app_1  | <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">15</span>,<span class="hljs-number">869</span> INFO spawned: <span class="hljs-string">&#x27;app&#x27;</span> with pid <span class="hljs-number">1820</span><br></code></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Supervisor&quot;&gt;&lt;a href=&quot;#Supervisor&quot; class=&quot;headerlink&quot; title=&quot;Supervisor&quot;&gt;&lt;/a&gt;Supervisor&lt;/h2&gt;&lt;p&gt;supervisord 또는 supervisordctl command 
      
    
    </summary>
    
      <category term="프로그래밍" scheme="https://the-masked-developer.github.io/categories/%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/"/>
    
    
  </entry>
  
  <entry>
    <title>글 작성 가이드</title>
    <link href="https://the-masked-developer.github.io/wiki/guide/"/>
    <id>https://the-masked-developer.github.io/wiki/guide/</id>
    <published>2021-11-09T13:22:22.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h2 id="글-작성-가이드"><a href="#글-작성-가이드" class="headerlink" title="글 작성 가이드"></a>글 작성 가이드</h2><p>사용할 수 있는 마크다운 문법 및 추가적인 플러그인 사용법에 관해서 기술</p><span id="more"></span><p>emphasis: <code>keyword</code></p><p>highlight.js</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fib</span>(<span class="hljs-params">n</span>):</span><br>    a, b = <span class="hljs-number">0</span>, <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> a &lt; n:<br>        <span class="hljs-built_in">print</span>(a, end=<span class="hljs-string">&#x27; &#x27;</span>)<br>        a, b = b, a+b<br>    <span class="hljs-built_in">print</span>()<br>fib(<span class="hljs-number">1000</span>)<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Map <span class="hljs-keyword">struct</span> &#123;<br>    mu Mutex<br>    read atomic.Value<br>    dirty <span class="hljs-keyword">map</span>[<span class="hljs-keyword">interface</span>&#123;&#125;]*entry<br>    misses <span class="hljs-keyword">int</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h2><table><thead><tr><th>Header 1</th><th>Header 2</th><th>Header 3</th></tr></thead><tbody><tr><td>Key 1</td><td>Value 1</td><td>Comment 1</td></tr><tr><td>Key 2</td><td>Value 2</td><td>Comment 2</td></tr><tr><td>Key 3</td><td>Value 3</td><td>Comment 3</td></tr></tbody></table><h2 id="H2"><a href="#H2" class="headerlink" title="H2"></a>H2</h2><h3 id="H3"><a href="#H3" class="headerlink" title="H3"></a>H3</h3><p>번호가 있는 목록</p><ol><li>A</li><li>B</li><li>C</li></ol><h3 id="H3-1"><a href="#H3-1" class="headerlink" title="H3"></a>H3</h3><p>번호가 없는 목록</p><ul><li>A</li><li>B</li><li>C</li></ul><h2 id="이미지"><a href="#이미지" class="headerlink" title="이미지"></a>이미지</h2><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Musee_de_la_bible_et_Terre_Sainte_001.JPG/440px-Musee_de_la_bible_et_Terre_Sainte_001.JPG" alt=""></p><h2 id="LaTex"><a href="#LaTex" class="headerlink" title="LaTex"></a>LaTex</h2><p>$$<br>\Gamma _ { \epsilon } ( x ) = [ 1- e ^ { - 2\pi \epsilon } ] ^ { 1- x } \prod _ { n = 0} ^ { \infty } \frac { 1- \operatorname{exp} ( - 2\pi \epsilon ( n + 1) ) } { 1- \operatorname{exp} ( - 2\pi \epsilon ( x + n ) ) }<br>$$</p><p>$$<br>\left( \begin{array} c t ^ { \prime } \ x ^ { \prime } \ y ^ { \prime } \ z ^ { \prime } \end{array} \right) = \left( \begin{array} { c c c c } { \gamma } &amp; { - \gamma \beta } &amp; { 0 } &amp; { 0 } \ { - \gamma \beta } &amp; { \gamma } &amp; { 0 } &amp; { 0 } \ { 0 } &amp; { 0 } &amp; { 1 } &amp; { 0 } \ { 0 } &amp; { 0 } &amp; { 0 } &amp; { 1 } \end{array} \right) \left( \begin{array} c t \ x \ y \ z \end{array} \right)<br>$$</p><p>$$<br>6 \mathrm { CO } _ { 2 } + 6 \mathrm { H } _ { 2 } \mathrm { O } \rightarrow \mathrm { C } _ { 6 } \mathrm { H } _ { 12 } \mathrm { O } _ { 6 } + 6 \mathrm { O } _ { 2 }<br>$$</p><h2 id="mermaid-flowchart"><a href="#mermaid-flowchart" class="headerlink" title="mermaid flowchart"></a>mermaid flowchart</h2><pre><code class=" mermaid">sequenceDiagramparticipant Aliceparticipant BobAlice-&gt;&gt;John: Hello John, how are you?loop Healthcheck    John-&gt;&gt;John: Fight against hypochondriaendNote right of John: Rational thoughts &lt;br/&gt;prevail...John--&gt;&gt;Alice: Great!John-&gt;&gt;Bob: How about you?Bob--&gt;&gt;John: Jolly good!</code></pre><pre><code class=" mermaid">ganttdateFormat  YYYY-MM-DDtitle Adding GANTT diagram to mermaidsection A sectionCompleted task            :done,    des1, 2014-01-06,2014-01-08Active task               :active,  des2, 2014-01-09, 3dFuture task               :         des3, after des2, 5dFuture task2               :         des4, after des3, 5d</code></pre><pre><code class=" mermaid">classDiagramClass01 &lt;|-- AveryLongClass : CoolClass03 *-- Class04Class05 o-- Class06Class07 .. Class08Class09 --&gt; C2 : Where am i?Class09 --* C3Class09 --|&gt; Class07Class07 : equals()Class07 : Object[] elementDataClass01 : size()Class01 : int chimpClass01 : int gorillaClass08 &lt;--&gt; C2: Cool label</code></pre><h3 id="note"><a href="#note" class="headerlink" title="note"></a>note</h3><div class="note note-info">            <p>Info <code>markdown</code></p>          </div><div class="note note-warning">            <p>Warning <code>markdown</code></p>          </div><div class="note note-primary">            <p>etc <code>markdown</code></p>          </div><h3 id="label"><a href="#label" class="headerlink" title="label"></a>label</h3><span class="label label-info">info</span> <span class="label label-warning">warning</span> <span class="label label-primary">primary</span><h3 id="checkbox"><a href="#checkbox" class="headerlink" title="checkbox"></a>checkbox</h3><div>            <input type="checkbox" disabled checked="checked">checkbox          </div><div>            <input type="checkbox" disabled >checkbox          </div><h3 id="js"><a href="#js" class="headerlink" title="js"></a>js</h3><a class="btn" href="javascript:window.alert(hi);"  target="_blank">button</a><h3 id="이미지-분할"><a href="#이미지-분할" class="headerlink" title="이미지 분할"></a>이미지 분할</h3><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Musee_de_la_bible_et_Terre_Sainte_001.JPG/440px-Musee_de_la_bible_et_Terre_Sainte_001.JPG" alt=""></div><div class="group-image-wrap"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Musee_de_la_bible_et_Terre_Sainte_001.JPG/440px-Musee_de_la_bible_et_Terre_Sainte_001.JPG" alt=""></div><div class="group-image-wrap"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Musee_de_la_bible_et_Terre_Sainte_001.JPG/440px-Musee_de_la_bible_et_Terre_Sainte_001.JPG" alt=""></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Musee_de_la_bible_et_Terre_Sainte_001.JPG/440px-Musee_de_la_bible_et_Terre_Sainte_001.JPG" alt=""></div><div class="group-image-wrap"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Musee_de_la_bible_et_Terre_Sainte_001.JPG/440px-Musee_de_la_bible_et_Terre_Sainte_001.JPG" alt=""></div></div></div><h3 id="참조"><a href="#참조" class="headerlink" title="참조"></a>참조</h3><p>나무위키 태그<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="수장형이 좋아할듯">[1]</span></a></sup>：</p><p>나무위키 태그<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="맞지?">[2]</span></a></sup>。</p><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>수장형이 좋아할듯<a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>맞지?<a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;글-작성-가이드&quot;&gt;&lt;a href=&quot;#글-작성-가이드&quot; class=&quot;headerlink&quot; title=&quot;글 작성 가이드&quot;&gt;&lt;/a&gt;글 작성 가이드&lt;/h2&gt;&lt;p&gt;사용할 수 있는 마크다운 문법 및 추가적인 플러그인 사용법에 관해서 기술&lt;/p&gt;
    
    </summary>
    
      <category term="글쓰기" scheme="https://the-masked-developer.github.io/categories/%EA%B8%80%EC%93%B0%EA%B8%B0/"/>
    
    
      <category term="글쓰기" scheme="https://the-masked-developer.github.io/tags/%EA%B8%80%EC%93%B0%EA%B8%B0/"/>
    
  </entry>
  
  <entry>
    <title>CORS 이해하기</title>
    <link href="https://the-masked-developer.github.io/wiki/cors/"/>
    <id>https://the-masked-developer.github.io/wiki/cors/</id>
    <published>2021-03-09T13:22:22.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h3 id="CORS-란"><a href="#CORS-란" class="headerlink" title="CORS 란"></a>CORS 란</h3><p>교차 출처 리소스 공유 ( Cross-Origin Resource Sharing) 을 의미한다.</p><p>여기서 출처 ( Origin ) 이란</p><p><code>https://api.server.com/blah/blah</code>  와 같은 URL 에서</p><p>프로토콜 + 호스트 + 포트 를 전부 합친 서버의 위치, 리소스의 출처를 의미한다</p><p>포트는 기본 프로토콜 포트번호가 정해져 있기 때문에 생략할 수 있으며, 만약 명시적으로 포트가 포함되어 있다면 포트번호까지 모두 일치해야 한다.</p><h3 id="SOP-Same-Origin-Policy"><a href="#SOP-Same-Origin-Policy" class="headerlink" title="SOP ( Same-Origin Policy )"></a>SOP ( Same-Origin Policy )</h3><p>다른 출처로의 리소스 요청을 제한하는 보안 정책</p><p>다른 출처의 리소스를 마음대로 가져와서 사용할 수 있는 웹 환경은 매우 보안에 취약하다.그래서, 이러한 SOP 정책을 도입하여 안전한 환경을 구축 할 수 있지만, 다른 출처에 리소스를 가져와서 사용하는 일은 분명히 필요한 일이기에, 예외적으로 이를 허용해 줄 필요가 있다.</p><p>그 중 하나가 바로 CORS 정책을 지킨 리소스 요청이다.</p><p>이러한 보안 정책은 브라우저에 내장되어 있기 때문에 브라우저를 통하지 않고 서버 간 통신을 할 떄는 적용되지 않는다.</p><h3 id="CORS-의-기본적인-동작-방식"><a href="#CORS-의-기본적인-동작-방식" class="headerlink" title="CORS 의 기본적인 동작 방식"></a>CORS 의 기본적인 동작 방식</h3><p>클라이언트는 HTTP 프로토콜을 사용하여 요청을 보내게 되고,<br>이때 브라우저는 요청 헤더에 <code>Origin</code> 필드에 출처를 함께 담아 보낸다.</p><p>이 요청을 받은 서버는 응답 헤더의 <code>Access-Control-Allow-Origin</code> 이라는 키에 허용된 출처 값을 내려주고, 응답을 받은 브라우저는 자신이 보낸 요청의 Origin 과 서버가 보내준 응답의 <code>Access-Control-Allow-Origin</code> 을 비교해 본 후 유효성을 결정한다.</p><h2 id="세가지-시나리오"><a href="#세가지-시나리오" class="headerlink" title="세가지 시나리오"></a>세가지 시나리오</h2><h3 id="Preflight-Request"><a href="#Preflight-Request" class="headerlink" title="Preflight Request"></a>Preflight Request</h3><p>클라이언트가 요청을 보내기 전 브라우저가 보내게 되는 예비 요청이다</p><p>OPTIONS 메소드를 사용하여 서버가 어떤 것들을 허용하고, 어떤 것들을 금지하고 있는지에 대한 정보를 담아오게 된다. 브라우저는 이 요청을 검사한 후 본 요청의 송신 여부를 결정하게 된다.</p><h3 id="Simple-Request"><a href="#Simple-Request" class="headerlink" title="Simple Request"></a>Simple Request</h3><p>브라우저가 예비요청을 보내지 않고 바로 본 요청을 보내는 경우도 있다.</p><p>아래에 특정한 조건을 만족하는 경우에 보내지게 된다.</p><ol><li>요청의 메소드는 <code>GET</code>, <code>HEAD</code>, <code>POST</code> 중 하나여야 한다.</li><li><code>Accept</code>, <code>Accept-Language</code>, <code>Content-Language</code>, <code>Content-Type</code>, <code>DPR</code>, <code>Downlink</code>, <code>Save-Data</code>, <code>Viewport-Width</code>, <code>Width</code>를 제외한 헤더를 사용하면 안된다.</li><li>만약 <code>Content-Type</code>를 사용하는 경우에는 <code>application/x-www-form-urlencoded</code>, <code>multipart/form-data</code>, <code>text/plain</code>만 허용된다.</li></ol><h3 id="Credentialed-Request"><a href="#Credentialed-Request" class="headerlink" title="Credentialed Request"></a>Credentialed Request</h3><p>클라이언트에 요청에 자격증명모드가 <code>include</code> 일경우 발생한다. </p><p>이러한 경우 브라우저에 보안 정책이 한가지 더 추가 되게 된다.</p><p>브라우저는 쿠키정보나 인증과 관련된 헤더를 함부로 요청에 담지 않는다. 이러한 인증정보를 요청에 담을 수 있게 해주는 옵션이 바로 <code>Request.credentails</code> 옵션이다.</p><ol><li><code>same-origin (default)</code>  :  같은 출처 간 요청에만 인증 정보를 담을 수 있다.</li><li><code>include</code>  :  모든 요청에 인증 정보를 담을 수 있다.</li><li><code>omit</code>  :  모든 요청에 인증 정보를 담지 않는다</li></ol><p>만약 다른 출처로 인증관련 헤더를 포함하여 요청을 보내고 싶다면<br>credentials 의 include 모드를 사용하여 요청을 작성하여 보내야 한다. </p><p>이때 발생할 수 있는 두가지 정책 위반이 있다.</p><div class="note note-info">            <p>🚨  Access to fetch at ’<a href="https://api.server.com’">https://api.server.com’</a> from origin ’<a href="http://localhost:8000’">http://localhost:8000’</a> has been blocked by CORS policy: The value of the ‘Access-Control-Allow-Origin’ header in the response must not be the wildcard ’*’ when the request’s credentials mode is ‘include’.</p>          </div><div class="note note-info">            <p>🚨  Access to XMLhttpRequest at ’<a href="https://api.server.com’">https://api.server.com’</a> from origin ’<a href="http://localhost:8000’">http://localhost:8000’</a> has been blocked by CORS policy: Response to preflight request doesn’t pass access control check: The value of the ‘Access-Control-Allow-Credentials’ header in the response is ‘ ‘ which must be ‘true’ when the request’s credentials mode is ‘include’. The credentials mode of requests initiated by the  XMLhttpRequest is controlled by the withCredentials attribute.</p>          </div><div class="note note-warning">            <ol><li>* 를 <code>Access-Control-Allow-Origin</code> 헤더에 사용하면 안된다.</li><li>응답 헤더에 반드시 <code>Access-Control-Allow-Credentials: true</code> 가 존재해야한다.</li></ol>          </div><h2 id="해결방법"><a href="#해결방법" class="headerlink" title="해결방법"></a>해결방법</h2><h3 id="Access-Control-Allow-Origin-세팅하기"><a href="#Access-Control-Allow-Origin-세팅하기" class="headerlink" title="Access-Control-Allow-Origin 세팅하기"></a>Access-Control-Allow-Origin 세팅하기</h3><p>nginx 설정에서 헤더값을 세팅해주거나</p><p>application 에서 세팅해주거나 하면 된다.</p><p>* 로 전체를 허용해 주기 보다는 특정한 출처를 명시해주는 편이 좋다.</p><h3 id="Webpack-Dev-Server-로-리버스-프록싱하기"><a href="#Webpack-Dev-Server-로-리버스-프록싱하기" class="headerlink" title="Webpack Dev Server 로 리버스 프록싱하기"></a>Webpack Dev Server 로 리버스 프록싱하기</h3><p>devServer 에 proxy 옵션을 사용해 특정 주소로 프록싱을 해주면</p><p>브라우저는 내가 세팅한 특정주소를 Origin 으로 알고 요청을 보내기 때문에 </p><p>CORS 정책을 지킨 것 처럼 브라우저를 속이고 통신할 수 있다.</p><h3 id="Hosts-파일-이용하기"><a href="#Hosts-파일-이용하기" class="headerlink" title="Hosts 파일 이용하기"></a>Hosts 파일 이용하기</h3><p>hosts 파일 위치 : <code>C:\Windows\System32\drivers\etc</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:8080api.front.com<br></code></pre></td></tr></table></figure><p>호스트파일을 위와 같이 변경하여 마치 같은 Origin 인 것처럼 속일 수 도 있다.</p><h3 id="참고자료"><a href="#참고자료" class="headerlink" title="참고자료"></a>참고자료</h3><hr><p><a href="https://evan-moon.github.io/2020/05/21/about-cors/">CORS는 왜 이렇게 우리를 힘들게 하는걸까?</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;CORS-란&quot;&gt;&lt;a href=&quot;#CORS-란&quot; class=&quot;headerlink&quot; title=&quot;CORS 란&quot;&gt;&lt;/a&gt;CORS 란&lt;/h3&gt;&lt;p&gt;교차 출처 리소스 공유 ( Cross-Origin Resource Sharing) 을 의미한다.&lt;
      
    
    </summary>
    
      <category term="web" scheme="https://the-masked-developer.github.io/categories/web/"/>
    
    
      <category term="web" scheme="https://the-masked-developer.github.io/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>리눅스에서 무슨무슨 so 파일이 없다고 할 때</title>
    <link href="https://the-masked-developer.github.io/wiki/no-so-file/"/>
    <id>https://the-masked-developer.github.io/wiki/no-so-file/</id>
    <published>2021-03-09T13:22:22.000Z</published>
    <updated>2022-09-13T06:26:04.097Z</updated>
    
    <content type="html"><![CDATA[<h3 id="발단"><a href="#발단" class="headerlink" title="발단"></a>발단</h3><hr><p>nodejs 에서 oracledb 클라이언트를 다운받아 사용하려고 하면 항상 만나는 에러메시지가 있다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">문제가 있으니<br>이걸 보고 해결하시오<br>https://oracle.github.io/node-oracledb/INSTALL.html<span class="hljs-comment">#overview</span><br></code></pre></td></tr></table></figure><p>나는 이러한 에러를 만났다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">libclntsh.so: cannot open shared object file: No such file or directory<br>libaio.so.1: cannot open shared object file: No such file or directory<br></code></pre></td></tr></table></figure><p>so 파일은 shared object 파일이란 뜻으로 특정한 기능을 구현해 놓은 라이브러리 파일이다.</p><p>즉 내 컴퓨터에 저 파일이 없어서 오라클 클라이언트를 사용할 수 없다고 하는 문제인 것이다.</p><p>파일을 다운로드해서, 리눅스에서 라이브러리를 로딩하려면</p><p><strong><em>ldconfig</em></strong> 라는 명령어를 사용해서, </p><p>/etc/ld.so.conf 파일에 설정된 라이브러리 정보를<br>/etc/ld.so.cache 파일로 만들어 준후</p><p>리눅스에 로더 가 라이브러리를 찾아 사용할 수 있도록 해주면 된다.</p><h3 id="해결"><a href="#해결" class="headerlink" title="해결"></a>해결</h3><hr><div class="note note-info">            <p>💡 리눅스는 so 파일을 아래와 같은 순서로 찾는다</p><ol><li>system default 경로</li><li>LD_LIBRARY_PATH</li><li>binary code 에 hard-coding 된 경로</li></ol>          </div><p>시스템 디폴트 경로에 so 파일을 등록하는 방법을 알아보자.</p><p><strong>1. system default 경로</strong></p><p>이 값은 /etc/ld.so.conf 파일에 설정이 된 값이다. (일반적으로 /usr/local/bin 과 /usr/bin 이다)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ more /etc/ld.so.conf<br>include /etc/ld.so.conf.d/*conf<br></code></pre></td></tr></table></figure><p> /etc/ld.so.conf.d/*conf 에 해당하는 모든 파일의 내용을 포함하고 있다.</p><p>새로운 라이브러리를 리눅스에 등록하고 싶다면,<br>추가할 라이브러리 파일의 경로를 저장한 파일을<br>위와 같은 파일 이름 형식으로 만들어 위 경로에 저장해 주면 된다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ls -al /usr/lib/oracle/19.6/client64/lib<br>libclntsh.so<br>lib~~~<br>lib~~~<br>lib~~~<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># /etc/ld.so.conf.d/oracle.conf</span><br>/usr/lib/oracle/19.6/client64/lib<br></code></pre></td></tr></table></figure><p>원하는 버전의 오라클 클라이언트를 위 경로에 다운 받은 후,</p><p>위와 같은 파일을 만들어 경로를 등록 해 준후 <strong><em>ldconfig</em></strong> 명령어로 등록하면 사용할 수 있다</p><p>+) libaio1 은 아래와같이 패키지매니저로 설치해 줄 수 있다. </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get install libaio1<br></code></pre></td></tr></table></figure><p>++) 라이브러리 파일에 실행권한이 있냐 없냐 여부는 상관이 없는것 같다.</p><p>+++) 라이브러리 파일이 심볼릭 링크인지 여부는 당연히 상관이 없다.</p><h3 id="참고한-자료들"><a href="#참고한-자료들" class="headerlink" title="참고한 자료들"></a>참고한 자료들</h3><hr><p><a href="https://adnoctum.tistory.com/541">리눅스에서 무슨무슨 so 파일이 없다고 할 때</a><br><a href="https://jacking75.github.io/Linux_lib_setting/">C++ - [펌] Linux에서 라이브러리 로딩</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;발단&quot;&gt;&lt;a href=&quot;#발단&quot; class=&quot;headerlink&quot; title=&quot;발단&quot;&gt;&lt;/a&gt;발단&lt;/h3&gt;&lt;hr&gt;
&lt;p&gt;nodejs 에서 oracledb 클라이언트를 다운받아 사용하려고 하면 항상 만나는 에러메시지가 있다.&lt;/p&gt;
&lt;fi
      
    
    </summary>
    
      <category term="linux" scheme="https://the-masked-developer.github.io/categories/linux/"/>
    
    
      <category term="linux" scheme="https://the-masked-developer.github.io/tags/linux/"/>
    
  </entry>
  
</feed>
